{% extends "settings_base.html" %}

{% block settings_content %}
    <hgroup>
        <h1>Configuration</h1>
        <h2>Configure your API credentials and preferences</h2>
    </hgroup>

    <!-- Tesla Authentication Options -->
    <article>
        <header>
            <strong>Tesla API Authentication</strong>
        </header>
        <p>Choose your Tesla API provider for energy management (Powerwall/Solar).</p>

        <!-- Provider Selection -->
        <form action="{{ url_for('main.settings') }}" method="post" style="margin-bottom: 1em;">
            {{ form.hidden_tag() }}
            <label for="tesla_api_provider">
                {{ form.tesla_api_provider.label }}
                <small>{{ form.tesla_api_provider.description }}</small>
                {{ form.tesla_api_provider(onchange="this.form.submit()") }}
            </label>
        </form>

        <!-- Teslemetry Card (shown if provider is 'teslemetry') -->
        {% if current_user.tesla_api_provider == 'teslemetry' or not current_user.tesla_api_provider %}
        <article style="margin-top: 1em;">
            <header style="background: rgba(100, 200, 150, 0.1); padding: 0.5em; border-radius: 0.5em;">
                <strong>Teslemetry</strong>
                <br><small>Tesla API Proxy Service (~$4/month)</small>
            </header>

            {% if current_user.teslemetry_api_key_encrypted %}
                <!-- Connected -->
                <div style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Connected</strong></p>
                </div>

                <p style="font-size: 0.85em; margin: 0.5em 0;">API Key configured</p>

                <form action="{{ url_for('main.teslemetry_disconnect') }}" method="post" style="margin: 0.5em 0 0 0;">
                    <button type="submit" class="outline" style="width: 100%; font-size: 0.85em;" onclick="return confirm('Disconnect Teslemetry?')">Disconnect</button>
                </form>
            {% else %}
                <!-- Not connected -->
                <div style="padding: 0.8em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0; color: #999; font-size: 0.9em;">‚≠ï <strong>Not Configured</strong></p>
                    <p style="margin: 0.3em 0 0 0; font-size: 0.75em;">Enter API key in the form below</p>
                </div>

                <details style="margin-top: 0.5em;" open>
                    <summary style="font-size: 0.85em;">Setup Instructions</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 150, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0 0 0.5em 0;"><strong>‚úÖ Works with localhost (no public domain needed)</strong></p>

                        <ol style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.3em 0;">Go to <a href="https://teslemetry.com" target="_blank" style="font-weight: bold;">teslemetry.com</a></li>
                            <li style="margin: 0.3em 0;">Sign in with your Tesla account</li>
                            <li style="margin: 0.3em 0;">Authorize Teslemetry</li>
                            <li style="margin: 0.3em 0;">Copy your API key</li>
                            <li style="margin: 0.3em 0;">Paste it in the API Configuration section below</li>
                        </ol>
                    </div>
                </details>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">About Teslemetry</summary>
                    <p style="font-size: 0.8em; margin-top: 0.5em;">
                        ‚úì Easy setup (2 minutes)<br>
                        ‚úì Works with localhost<br>
                        ‚úì ~$4/month for energy sites<br>
                        ‚úì Handles Tesla authentication<br>
                        ‚úì Reliable and well-maintained
                    </p>
                </details>
            {% endif %}
        </article>
        {% endif %}

        <!-- Fleet API Card (shown if provider is 'fleet_api') -->
        {% if current_user.tesla_api_provider == 'fleet_api' %}
        <article style="margin-top: 1em;">
            <header style="background: rgba(100, 150, 255, 0.1); padding: 0.5em; border-radius: 0.5em;">
                <strong>Tesla Fleet API</strong>
                <br><small>Direct Tesla API (Free)</small>
            </header>

            {% if current_user.fleet_api_access_token_encrypted %}
                <!-- Connected -->
                <div style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Connected</strong></p>
                </div>

                <p style="font-size: 0.85em; margin: 0.5em 0;">
                    OAuth tokens configured<br>
                    {% if current_user.fleet_api_token_expires_at %}
                    Token expires: {{ current_user.fleet_api_token_expires_at.strftime('%Y-%m-%d %H:%M UTC') }}
                    {% endif %}
                </p>

                <a href="{{ url_for('main.fleet_api_oauth_start') }}" class="outline" style="display: block; text-align: center; width: 100%; font-size: 0.85em; margin-top: 0.5em;">Reconnect / Refresh Tokens</a>

                <!-- Key Status and Generation -->
                <div id="keyStatusSection" style="padding: 0.6em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0; font-size: 0.85em;">
                        <strong>Domain Keys:</strong> <span id="keyStatusText">Checking...</span>
                    </p>
                </div>

                <button type="button" id="generateKeysBtn" class="outline" style="display: block; text-align: center; width: 100%; font-size: 0.85em; margin-top: 0.5em;" onclick="generateKeys()">
                    Generate Domain Keys
                </button>
                <p id="generateKeysStatus" style="font-size: 0.8em; margin-top: 0.3em; display: none;"></p>

                <!-- Tunnel Section -->
                <div id="tunnelSection" style="padding: 0.6em; background: rgba(100, 150, 255, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0 0 0.5em 0; font-size: 0.85em;">
                        <strong>Public Tunnel (ngrok)</strong>
                    </p>
                    <div style="margin-bottom: 0.5em;">
                        <label for="ngrokAuthtoken" style="font-size: 0.8em; margin-bottom: 0.2em; display: block;">
                            Authtoken <small>(<a href="https://dashboard.ngrok.com/get-started/your-authtoken" target="_blank">get free token</a>)</small>
                        </label>
                        <div style="display: flex; gap: 0.3em; align-items: center;">
                            <input type="password" id="ngrokAuthtoken" placeholder="Enter ngrok authtoken" style="flex: 1; font-size: 0.85em; padding: 0.4em; margin: 0;" value="{{ ngrok_authtoken or '' }}">
                            <button type="button" class="outline" style="font-size: 0.8em; padding: 0.4em 0.8em; margin: 0; white-space: nowrap; width: auto;" onclick="saveNgrokToken()">Save</button>
                        </div>
                        <p id="ngrokTokenStatus" style="font-size: 0.75em; margin: 0.2em 0 0 0; display: none;"></p>
                    </div>
                    <p style="margin: 0; font-size: 0.85em;">
                        <strong>Status:</strong> <span id="tunnelStatusText">Checking...</span>
                    </p>
                    <div id="tunnelUrlDisplay" style="display: none; margin-top: 0.5em;">
                        <p style="margin: 0; font-size: 0.8em; word-break: break-all;">
                            <strong>URL:</strong> <code id="tunnelUrl"></code>
                        </p>
                        <p style="margin: 0.3em 0 0 0; font-size: 0.75em; color: #666;">
                            Update Tesla Developer Portal with this URL
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5em; margin-top: 0.5em;">
                    <button type="button" id="startTunnelBtn" class="outline" style="flex: 1; text-align: center; font-size: 0.85em;" onclick="startTunnel()">
                        Start Tunnel
                    </button>
                    <button type="button" id="stopTunnelBtn" class="outline secondary" style="flex: 1; text-align: center; font-size: 0.85em; display: none;" onclick="stopTunnel()">
                        Stop Tunnel
                    </button>
                </div>
                <p id="tunnelActionStatus" style="font-size: 0.8em; margin-top: 0.3em; display: none;"></p>

                <button type="button" id="registerDomainBtn" class="outline" style="display: block; text-align: center; width: 100%; font-size: 0.85em; margin-top: 0.5em;" onclick="registerDomain()">
                    Register Domain with Tesla
                </button>
                <p id="registerDomainStatus" style="font-size: 0.8em; margin-top: 0.3em; display: none;"></p>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">Can't expose your server to the internet?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 255, 0.1); border-radius: 0.3em;">
                        <p style="margin: 0 0 0.5em 0;">Use the <strong>Public Tunnel</strong> feature above to temporarily expose your app:</p>
                        <ol style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.3em 0;">Click <strong>"Generate Domain Keys"</strong></li>
                            <li style="margin: 0.3em 0;">Click <strong>"Start Tunnel"</strong> to get a public URL</li>
                            <li style="margin: 0.3em 0;">Update <strong>Tesla Developer Portal</strong> with the tunnel URL:
                                <ul style="margin: 0.2em 0 0 1em;">
                                    <li>Allowed Origins: <code>[tunnel-url]</code></li>
                                    <li>Redirect URI: <code>[tunnel-url]/fleet-api/callback</code></li>
                                </ul>
                            </li>
                            <li style="margin: 0.3em 0;">Update <strong>Redirect URI</strong> in settings below</li>
                            <li style="margin: 0.3em 0;">Click <strong>"Register Domain with Tesla"</strong></li>
                            <li style="margin: 0.3em 0;">Complete OAuth authorization</li>
                            <li style="margin: 0.3em 0;">Click <strong>"Stop Tunnel"</strong> when done</li>
                        </ol>
                    </div>
                </details>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">Getting 412 Precondition Failed?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(255, 200, 100, 0.1); border-radius: 0.3em;">
                        <p style="margin: 0 0 0.5em 0;">If you see "412 Precondition Failed" errors, follow these steps:</p>
                        <ol style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.3em 0;">Click <strong>"Generate Domain Keys"</strong> above</li>
                            <li style="margin: 0.3em 0;">Verify the key is accessible at your domain: <code>/.well-known/appspecific/com.tesla.3p.public-key.pem</code></li>
                            <li style="margin: 0.3em 0;">Click <strong>"Register Domain with Tesla"</strong></li>
                        </ol>
                    </div>
                </details>
            {% else %}
                <!-- Not connected - Setup Flow -->

                <!-- Step 1: Tunnel -->
                <div style="padding: 0.6em; background: rgba(100, 150, 255, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0 0 0.4em 0; font-size: 0.85em;">
                        <strong>1. Start Public Tunnel</strong>
                        <small style="color: #888; margin-left: 0.5em;">(<a href="https://dashboard.ngrok.com/get-started/your-authtoken" target="_blank">get free ngrok token</a>)</small>
                    </p>
                    <div style="display: flex; gap: 0.3em; align-items: center; margin-bottom: 0.4em;">
                        <input type="password" id="ngrokAuthtokenSetup" placeholder="ngrok authtoken" style="flex: 1; font-size: 0.85em; padding: 0.4em; margin: 0;" value="{{ ngrok_authtoken or '' }}">
                        <button type="button" class="outline" style="font-size: 0.8em; padding: 0.4em 0.8em; margin: 0; white-space: nowrap; width: auto;" onclick="saveNgrokTokenSetup()">Save</button>
                    </div>
                    <p id="ngrokTokenStatusSetup" style="font-size: 0.75em; margin: 0 0 0.3em 0; display: none;"></p>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        <span style="font-size: 0.85em;"><span id="tunnelStatusTextSetup">Checking...</span></span>
                        <button type="button" id="startTunnelBtnSetup" class="outline" style="font-size: 0.8em; padding: 0.3em 0.8em; margin: 0;" onclick="startTunnel()">Start</button>
                        <button type="button" id="stopTunnelBtnSetup" class="outline secondary" style="font-size: 0.8em; padding: 0.3em 0.8em; margin: 0; display: none;" onclick="stopTunnel()">Stop</button>
                    </div>
                    <div id="tunnelUrlDisplaySetup" style="display: none; margin-top: 0.4em;">
                        <code id="tunnelUrlSetup" style="font-size: 0.75em; word-break: break-all;"></code>
                    </div>
                    <p id="tunnelActionStatusSetup" style="font-size: 0.75em; margin: 0.3em 0 0 0; display: none;"></p>
                </div>

                <!-- Step 2: Tesla Developer Portal -->
                <div style="padding: 0.6em; background: rgba(255, 200, 100, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0 0 0.3em 0; font-size: 0.85em;"><strong>2. Update <a href="https://developer.tesla.com" target="_blank">Tesla Developer Portal</a></strong></p>
                    <div style="font-size: 0.8em; background: rgba(0,0,0,0.2); padding: 0.4em; border-radius: 0.3em;">
                        <div style="margin-bottom: 0.2em;"><strong>Allowed Origins:</strong> <code id="allowedOriginHint" style="font-size: 0.9em;">[start tunnel]</code></div>
                        <div><strong>Redirect URI:</strong> <code id="redirectUriHint" style="font-size: 0.9em;">[start tunnel]</code></div>
                    </div>
                    <p style="margin: 0.3em 0 0 0; font-size: 0.75em; color: #888;">Copy Client ID & Secret to the form below, then save.</p>
                </div>

                <!-- Step 3: Generate Keys & Register -->
                <div style="padding: 0.6em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0 0 0.3em 0; font-size: 0.85em;"><strong>3. Generate Keys & Register Domain</strong></p>
                    <div id="keyStatusSectionSetup" style="margin-bottom: 0.3em;">
                        <span style="font-size: 0.8em;">Keys: <span id="keyStatusTextSetup">Checking...</span></span>
                    </div>
                    <div style="display: flex; gap: 0.5em;">
                        <button type="button" id="generateKeysBtnSetup" class="outline" style="flex: 1; font-size: 0.8em; padding: 0.4em;" onclick="generateKeys()">Generate Keys</button>
                        <button type="button" id="registerDomainBtnSetup" class="outline" style="flex: 1; font-size: 0.8em; padding: 0.4em;" onclick="registerDomain()">Register Domain</button>
                    </div>
                    <p id="generateKeysStatusSetup" style="font-size: 0.75em; margin: 0.3em 0 0 0; display: none;"></p>
                    <p id="registerDomainStatusSetup" style="font-size: 0.75em; margin: 0.3em 0 0 0; display: none;"></p>
                </div>

                <!-- Step 4: OAuth -->
                <div style="padding: 0.6em; background: rgba(0, 200, 100, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                    <p style="margin: 0 0 0.3em 0; font-size: 0.85em;"><strong>4. Connect to Tesla</strong></p>
                    <a href="{{ url_for('main.fleet_api_oauth_start') }}" class="outline" style="display: block; text-align: center; width: 100%; font-size: 0.85em;">Authorize with Tesla</a>
                </div>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">About Fleet API</summary>
                    <p style="font-size: 0.8em; margin-top: 0.5em;">
                        ‚úì Completely free<br>
                        ‚úì Direct connection to Tesla<br>
                        ‚úì GUI-based configuration (no .env needed)<br>
                        ‚úó Requires Tesla developer account<br>
                        ‚úó OAuth setup required<br>
                        ‚úó Tokens expire every 8 hours (auto-refresh)
                    </p>
                </details>
            {% endif %}
        </article>
        {% endif %}
    </article>

    <!-- API Configuration Section -->
    <article>
        <header><strong>API Configuration</strong></header>
        <p>Configure your API credentials and energy site information.</p>
        <form action="{{ url_for('main.settings') }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            <fieldset>
                <legend>Amber Electric</legend>
                <label for="amber_token">
                    {{ form.amber_token.label }}
                    <small>Get this from your Amber developer settings.</small>
                </label>
                <div style="display: flex; align-items: center; gap: 0.5em;">
                    {{ form.amber_token(size=64, type='password', class='secure-field', style='width: 100%;') }}
                    <button type="button" onclick="toggleVisibility('amber_token', this)"
                            style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                   font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                            aria-label="Toggle visibility" title="Show/Hide API Token">
                        üëÅÔ∏è
                    </button>
                </div>
            </fieldset>

            <fieldset style="margin-top: 1em;">
                <legend>Teslemetry (Optional)</legend>
                <label for="teslemetry_api_key">
                    {{ form.teslemetry_api_key.label }}
                    <small>Sign up at <a href="https://teslemetry.com" target="_blank">teslemetry.com</a>, connect your Tesla account, and paste your API key here.</small>
                </label>
                <div style="display: flex; align-items: center; gap: 0.5em;">
                    {{ form.teslemetry_api_key(size=64, type='password', class='secure-field', style='width: 100%;') }}
                    <button type="button" onclick="toggleVisibility('teslemetry_api_key', this)"
                            style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                   font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                            aria-label="Toggle visibility" title="Show/Hide API Key">
                        üëÅÔ∏è
                    </button>
                </div>
            </fieldset>

            <fieldset style="margin-top: 1em;">
                <legend>Tesla Fleet API (Optional)</legend>
                <label for="fleet_api_client_id">
                    {{ form.fleet_api_client_id.label }}
                    <small>Register your application at <a href="https://developer.tesla.com" target="_blank">developer.tesla.com</a> and paste your Client ID here.</small>
                </label>
                <div style="display: flex; align-items: center; gap: 0.5em;">
                    {{ form.fleet_api_client_id(size=64, type='password', class='secure-field', style='width: 100%;') }}
                    <button type="button" onclick="toggleVisibility('fleet_api_client_id', this)"
                            style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                   font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                            aria-label="Toggle visibility" title="Show/Hide Client ID">
                        üëÅÔ∏è
                    </button>
                </div>

                <label for="fleet_api_client_secret" style="margin-top: 0.5em;">
                    {{ form.fleet_api_client_secret.label }}
                    <small>Your Client Secret from <a href="https://developer.tesla.com" target="_blank">developer.tesla.com</a>.</small>
                </label>
                <div style="display: flex; align-items: center; gap: 0.5em;">
                    {{ form.fleet_api_client_secret(size=64, type='password', class='secure-field', style='width: 100%;') }}
                    <button type="button" onclick="toggleVisibility('fleet_api_client_secret', this)"
                            style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                   font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                            aria-label="Toggle visibility" title="Show/Hide Client Secret">
                        üëÅÔ∏è
                    </button>
                </div>

                <label for="fleet_api_redirect_uri" style="margin-top: 0.5em;">
                    {{ form.fleet_api_redirect_uri.label }}
                    <small>OAuth callback URL. Must match what you registered at <a href="https://developer.tesla.com" target="_blank">developer.tesla.com</a>. Example: <code>http://localhost:5001/fleet-api/callback</code></small>
                </label>
                {{ form.fleet_api_redirect_uri(size=64, style='width: 100%;', placeholder='http://localhost:5001/fleet-api/callback') }}
            </fieldset>

            <fieldset style="margin-top: 1em;">
                <legend>Tesla Energy Site</legend>
                <div id="energy-site-container">
                    {% if current_user.tesla_energy_site_id %}
                    <div id="energy-site-status" style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                        <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Selected</strong></p>
                        <p style="margin: 0.3em 0 0 0; font-size: 0.85em;">
                            Site ID: <code id="current-site-id">{{ current_user.tesla_energy_site_id }}</code>
                        </p>
                    </div>
                    {% else %}
                    <div id="energy-site-status" style="padding: 0.8em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                        <p style="margin: 0; color: #999; font-size: 0.9em;">‚≠ï <strong>Not selected</strong></p>
                        <p style="margin: 0.3em 0 0 0; font-size: 0.75em;">Connect your Tesla account above to detect your energy site.</p>
                    </div>
                    {% endif %}

                    <!-- Site selection dropdown (populated via JavaScript) -->
                    <div id="site-selector-container" style="display: none; margin-top: 0.5em;">
                        <label for="energy-site-select">
                            Select Energy Site
                            <select id="energy-site-select" style="width: 100%;">
                                <option value="">Loading sites...</option>
                            </select>
                        </label>
                        <button type="button" id="save-site-btn" onclick="saveSelectedSite()" class="outline" style="margin-top: 0.5em;">
                            Save Selection
                        </button>
                        <p id="site-save-status" style="font-size: 0.75em; margin-top: 0.3em; display: none;"></p>
                    </div>

                    <button type="button" onclick="loadEnergySites()" class="outline secondary" style="margin-top: 0.5em; font-size: 0.85em;">
                        üîÑ Refresh Sites
                    </button>
                </div>
            </fieldset>

            <fieldset style="margin-top: 1em;">
                <legend>AEMO Spike Detection</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Monitor AEMO NEM wholesale electricity prices and automatically switch to export mode during price spikes.
                    When the price exceeds your threshold, the system saves your current tariff and uploads a spike tariff that
                    encourages battery export. When prices return to normal, your original tariff is restored.
                </p>

                {% if current_user.sync_enabled %}
                <article style="background: rgba(255, 165, 0, 0.15); padding: 1em; border-radius: 0.5em; margin-bottom: 1em; border-left: 4px solid orange;">
                    <p style="margin: 0; font-size: 0.85em;">
                        ‚ö†Ô∏è <strong>Note:</strong> AEMO spike detection is automatically disabled when Amber auto sync is enabled.
                        To use spike detection, disable auto sync from the Dashboard first.
                    </p>
                </article>
                {% endif %}

                <label for="aemo_spike_detection_enabled">
                    <input type="checkbox" id="aemo_spike_detection_enabled" name="aemo_spike_detection_enabled"
                           {% if form.aemo_spike_detection_enabled.data %}checked{% endif %}
                           onchange="toggleAemoFields(this.checked)">
                    Enable AEMO Spike Detection
                </label>

                <div id="aemo-fields" style="{% if not form.aemo_spike_detection_enabled.data %}display: none;{% endif %} margin-top: 1em;">
                    <label for="aemo_region">
                        {{ form.aemo_region.label }}
                        <small>Select your NEM region for monitoring wholesale electricity prices</small>
                        {{ form.aemo_region() }}
                    </label>

                    <label for="aemo_spike_threshold">
                        {{ form.aemo_spike_threshold.label }}
                        <small>{{ form.aemo_spike_threshold.description }}</small>
                        <input type="number" id="aemo_spike_threshold" name="aemo_spike_threshold"
                               value="{{ form.aemo_spike_threshold.data or 300 }}" step="0.01" min="0"
                               placeholder="300.00" style="max-width: 200px;">
                    </label>

                    {% if current_user.aemo_spike_detection_enabled %}
                    <article style="background: rgba(100, 200, 150, 0.1); padding: 1em; border-radius: 0.5em; margin-top: 1em;">
                        <p style="margin: 0; font-size: 0.85em;"><strong>Status:</strong></p>
                        <ul style="margin: 0.5em 0 0 1.5em; padding: 0; font-size: 0.85em;">
                            <li>Region: <strong>{{ current_user.aemo_region or 'Not set' }}</strong></li>
                            <li>Threshold: <strong>${{ '%.2f'|format(current_user.aemo_spike_threshold or 0) }}/MWh</strong></li>
                            {% if current_user.aemo_last_price %}
                            <li>Last Price: <strong>${{ '%.2f'|format(current_user.aemo_last_price) }}/MWh</strong>
                                {% if current_user.aemo_in_spike_mode %}
                                    <span style="color: #dc3545;">‚ö†Ô∏è IN SPIKE MODE</span>
                                {% else %}
                                    <span style="color: #28a745;">‚úì Normal</span>
                                {% endif %}
                            </li>
                            {% endif %}
                            {% if current_user.aemo_last_check %}
                            <li>Last Check: {{ (current_user.aemo_last_check | user_timezone).strftime('%Y-%m-%d %H:%M:%S') }}</li>
                            {% endif %}
                        </ul>
                    </article>
                    {% endif %}

                    <details style="margin-top: 1em;">
                        <summary style="font-size: 0.85em;">How It Works</summary>
                        <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 150, 0.05); border-radius: 0.3em;">
                            <p style="margin: 0 0 0.5em 0;"><strong>Monitoring:</strong></p>
                            <ol style="margin: 0 0 0.5em 1.2em; padding: 0;">
                                <li>Every 5 minutes, checks AEMO NEM wholesale prices for your region</li>
                                <li>Prices are in $/MWh (e.g., $300/MWh = 30¬¢/kWh)</li>
                            </ol>

                            <p style="margin: 0.5em 0;"><strong>Spike Detection:</strong></p>
                            <ol style="margin: 0 0 0.5em 1.2em; padding: 0;">
                                <li>When price ‚â• threshold: Saves your current tariff to "Pre-Spike Backup"</li>
                                <li>Uploads a spike tariff with very high sell rates to encourage export</li>
                                <li>Tesla Powerwall sees high feed-in rates and exports battery to grid</li>
                            </ol>

                            <p style="margin: 0.5em 0;"><strong>Return to Normal:</strong></p>
                            <ol style="margin: 0 0 0.5em 1.2em; padding: 0;">
                                <li>When price &lt; threshold: Restores your saved tariff</li>
                                <li>Battery returns to normal operation</li>
                            </ol>

                            <p style="margin: 0.5em 0 0 0;"><strong>Note:</strong> This works alongside Amber sync. Spike detection temporarily overrides your rates during high-price events.</p>
                        </div>
                    </details>
                </div>
            </fieldset>

            {{ form.submit(class_="primary", style="margin-top: 1em;") }}
        </form>
    </article>

    <!-- AEMO Spike Testing (separate from main form) -->
    {% if current_user.aemo_spike_detection_enabled %}
    <article>
        <header><strong>AEMO Spike Detection Testing</strong></header>
        <p style="font-size: 0.85em;">Test the spike detection system without waiting for a real price spike.</p>

        <form method="POST" action="{{ url_for('main.test_aemo_spike') }}" style="display: inline; margin-right: 0.5em;">
            <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
            <button type="submit" class="outline"
                    onclick="return confirm('This will trigger spike mode using your configured threshold of ${{ current_user.aemo_spike_threshold }}/MWh. Your current tariff will be backed up and a spike tariff will be uploaded to Tesla. Continue?');">
                üö® Simulate Spike
            </button>
        </form>

        {% if current_user.aemo_in_spike_mode %}
        <form method="POST" action="{{ url_for('main.test_aemo_restore') }}" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
            <button type="submit" class="outline"
                    onclick="return confirm('This will exit spike mode and restore your backed-up tariff. Continue?');">
                ‚úì Restore Normal
            </button>
        </form>
        {% endif %}

        <p style="margin: 0.5em 0 0 0; font-size: 0.75em; color: var(--muted-color);">
            Click "Simulate Spike" to test the system. The app will save your current tariff and upload a spike tariff to Tesla.
            {% if current_user.aemo_in_spike_mode %}Click "Restore Normal" to exit spike mode and restore your original tariff.{% endif %}
        </p>
    </article>
    {% endif %}

    <script>
        // Check key status and tunnel status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkKeyStatus();
            checkTunnelStatus();
        });

        // Helper to save ngrok token (works for both connected and setup views)
        async function saveNgrokTokenGeneric(inputId, statusId) {
            const input = document.getElementById(inputId);
            const status = document.getElementById(statusId);
            if (!input || !status) return;

            const token = input.value.trim();
            status.style.display = 'block';
            status.style.color = '#666';
            status.textContent = 'Saving...';

            try {
                const response = await fetch('{{ url_for("main.save_ngrok_token") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ authtoken: token })
                });

                const data = await response.json();
                if (data.success) {
                    status.style.color = '#51cf66';
                    status.textContent = '‚úì Token saved';
                    setTimeout(() => { status.style.display = 'none'; }, 3000);
                } else {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó ' + (data.error || 'Failed to save');
                }
            } catch (error) {
                status.style.color = '#ff6b6b';
                status.textContent = '‚úó Error: ' + error.message;
            }
        }

        function saveNgrokToken() {
            saveNgrokTokenGeneric('ngrokAuthtoken', 'ngrokTokenStatus');
        }

        function saveNgrokTokenSetup() {
            saveNgrokTokenGeneric('ngrokAuthtokenSetup', 'ngrokTokenStatusSetup');
        }

        async function checkTunnelStatus() {
            try {
                const response = await fetch('{{ url_for("main.fleet_api_tunnel_status") }}');
                const data = await response.json();

                // Update connected view elements (if they exist)
                updateTunnelUI('tunnelStatusText', 'tunnelSection', 'tunnelUrlDisplay', 'tunnelUrl',
                              'startTunnelBtn', 'stopTunnelBtn', data);

                // Update setup view elements (if they exist)
                updateTunnelUI('tunnelStatusTextSetup', null, 'tunnelUrlDisplaySetup', 'tunnelUrlSetup',
                              'startTunnelBtnSetup', 'stopTunnelBtnSetup', data);

                // Update the hints in step 2 for setup view
                if (data.active && data.public_url) {
                    const originHint = document.getElementById('allowedOriginHint');
                    const redirectHint = document.getElementById('redirectUriHint');
                    if (originHint) originHint.textContent = data.public_url;
                    if (redirectHint) redirectHint.textContent = data.public_url + '/fleet-api/callback';

                    // Auto-fill the Redirect URI field in the form
                    const redirectUriField = document.getElementById('fleet_api_redirect_uri');
                    if (redirectUriField && (!redirectUriField.value || redirectUriField.value.includes('localhost') || redirectUriField.value.includes('ngrok'))) {
                        redirectUriField.value = data.public_url + '/fleet-api/callback';
                    }
                } else {
                    // Reset hints when tunnel is not active
                    const originHint = document.getElementById('allowedOriginHint');
                    const redirectHint = document.getElementById('redirectUriHint');
                    if (originHint) originHint.textContent = '[start tunnel first]';
                    if (redirectHint) redirectHint.textContent = '[start tunnel first]';
                }
            } catch (error) {
                console.error('Failed to check tunnel status:', error);
            }
        }

        function updateTunnelUI(statusTextId, sectionId, urlDisplayId, urlTextId, startBtnId, stopBtnId, data) {
            const statusText = document.getElementById(statusTextId);
            const statusSection = sectionId ? document.getElementById(sectionId) : null;
            const urlDisplay = document.getElementById(urlDisplayId);
            const urlText = document.getElementById(urlTextId);
            const startBtn = document.getElementById(startBtnId);
            const stopBtn = document.getElementById(stopBtnId);

            if (!statusText) return;

            if (data.active && data.public_url) {
                statusText.innerHTML = '<span style="color: #51cf66;">‚úì Active</span>';
                if (statusSection) statusSection.style.background = 'rgba(0, 255, 0, 0.1)';
                if (urlDisplay) urlDisplay.style.display = 'block';
                if (urlText) urlText.textContent = data.public_url;
                if (startBtn) startBtn.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'block';
            } else {
                statusText.innerHTML = '<span style="color: #999;">Not running</span>';
                if (statusSection) statusSection.style.background = 'rgba(100, 150, 255, 0.1)';
                if (urlDisplay) urlDisplay.style.display = 'none';
                if (startBtn) startBtn.style.display = 'block';
                if (stopBtn) stopBtn.style.display = 'none';
            }
        }

        async function startTunnel() {
            // Get buttons from both views
            const btn = document.getElementById('startTunnelBtn') || document.getElementById('startTunnelBtnSetup');
            const status = document.getElementById('tunnelActionStatus') || document.getElementById('tunnelActionStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Starting...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Initializing ngrok tunnel...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_start_tunnel") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    status.style.color = '#51cf66';
                    status.textContent = '‚úì Tunnel started! Update Tesla Developer Portal with the URL shown above.';
                    checkTunnelStatus();
                } else {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó ' + data.error;
                    btn.disabled = false;
                    btn.textContent = 'Start Tunnel';
                }
            } catch (error) {
                status.style.color = '#ff6b6b';
                status.textContent = '‚úó Request failed: ' + error.message;
                btn.disabled = false;
                btn.textContent = 'Start Tunnel';
            }
        }

        async function stopTunnel() {
            // Get buttons from both views
            const btn = document.getElementById('stopTunnelBtn') || document.getElementById('stopTunnelBtnSetup');
            const status = document.getElementById('tunnelActionStatus') || document.getElementById('tunnelActionStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Stopping...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Stopping tunnel...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_stop_tunnel") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    if (status) {
                        status.style.color = '#51cf66';
                        status.textContent = '‚úì Tunnel stopped';
                    }
                    checkTunnelStatus();
                    // Reset hints
                    const originHint = document.getElementById('allowedOriginHint');
                    const redirectHint = document.getElementById('redirectUriHint');
                    if (originHint) originHint.textContent = '[start tunnel first]';
                    if (redirectHint) redirectHint.textContent = '[start tunnel first]';
                } else {
                    if (status) {
                        status.style.color = '#ff6b6b';
                        status.textContent = '‚úó ' + data.error;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Stop Tunnel';
                    }
                }
            } catch (error) {
                if (status) {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó Request failed: ' + error.message;
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Stop Tunnel';
                }
            }
        }

        // Energy site selection functions
        async function loadEnergySites() {
            const container = document.getElementById('site-selector-container');
            const select = document.getElementById('energy-site-select');
            const status = document.getElementById('site-save-status');

            try {
                select.innerHTML = '<option value="">Loading...</option>';
                container.style.display = 'block';

                const response = await fetch('/api/tesla/energy-sites');
                const data = await response.json();

                if (data.error && !data.sites.length) {
                    select.innerHTML = '<option value="">Tesla not connected</option>';
                    return;
                }

                if (data.sites.length === 0) {
                    select.innerHTML = '<option value="">No energy sites found</option>';
                    return;
                }

                select.innerHTML = '';
                data.sites.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site.id;
                    option.textContent = `${site.name} (${site.id})`;
                    if (site.selected) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                if (data.sites.length > 1) {
                    status.textContent = `Found ${data.sites.length} energy sites`;
                    status.style.display = 'block';
                    status.style.color = '#888';
                }

            } catch (error) {
                console.error('Error loading energy sites:', error);
                select.innerHTML = '<option value="">Error loading sites</option>';
            }
        }

        async function saveSelectedSite() {
            const select = document.getElementById('energy-site-select');
            const status = document.getElementById('site-save-status');
            const siteId = select.value;

            if (!siteId) {
                status.textContent = 'Please select a site';
                status.style.display = 'block';
                status.style.color = 'orange';
                return;
            }

            try {
                status.textContent = 'Saving...';
                status.style.display = 'block';
                status.style.color = '#888';

                const response = await fetch('/api/tesla/select-site', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ site_id: siteId })
                });

                const data = await response.json();

                if (data.success) {
                    status.textContent = '‚úì Site saved successfully';
                    status.style.color = '#51cf66';

                    // Update the status display
                    const statusDiv = document.getElementById('energy-site-status');
                    statusDiv.style.background = 'rgba(0, 255, 0, 0.1)';
                    statusDiv.innerHTML = `
                        <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Selected</strong></p>
                        <p style="margin: 0.3em 0 0 0; font-size: 0.85em;">
                            Site ID: <code id="current-site-id">${siteId}</code>
                        </p>
                    `;
                } else {
                    status.textContent = '‚úó ' + (data.error || 'Failed to save');
                    status.style.color = 'red';
                }
            } catch (error) {
                console.error('Error saving site:', error);
                status.textContent = '‚úó Error saving site';
                status.style.color = 'red';
            }
        }

        async function checkKeyStatus() {
            try {
                const response = await fetch('{{ url_for("main.fleet_api_key_status") }}');
                const data = await response.json();

                // Update connected view
                updateKeyStatusUI('keyStatusText', 'keyStatusSection', 'generateKeysBtn', data);
                // Update setup view
                updateKeyStatusUI('keyStatusTextSetup', 'keyStatusSectionSetup', 'generateKeysBtnSetup', data);
            } catch (error) {
                console.error('Failed to check key status:', error);
            }
        }

        function updateKeyStatusUI(statusTextId, statusSectionId, generateBtnId, data) {
            const statusText = document.getElementById(statusTextId);
            const statusSection = document.getElementById(statusSectionId);
            const generateBtn = document.getElementById(generateBtnId);

            if (!statusText) return; // Element doesn't exist on this page

            if (data.keys_exist) {
                statusText.innerHTML = '<span style="color: #51cf66;">‚úì Keys configured</span>';
                if (statusSection) statusSection.style.background = 'rgba(0, 255, 0, 0.1)';
                if (generateBtn) generateBtn.textContent = 'Regenerate Domain Keys';
            } else {
                statusText.innerHTML = '<span style="color: #ff6b6b;">‚úó Keys not found</span>';
                if (statusSection) statusSection.style.background = 'rgba(255, 100, 100, 0.1)';
            }
        }

        async function generateKeys() {
            // Get buttons from both views
            const btn = document.getElementById('generateKeysBtn') || document.getElementById('generateKeysBtnSetup');
            const status = document.getElementById('generateKeysStatus') || document.getElementById('generateKeysStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Generating...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Creating EC key pair...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_generate_keys") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (status) {
                        status.style.color = '#51cf66';
                        if (data.keys_replaced) {
                            status.textContent = '‚úì Keys regenerated successfully';
                        } else {
                            status.textContent = '‚úì Keys generated successfully';
                        }
                    }
                    if (btn) {
                        btn.textContent = 'Regenerate Domain Keys';
                        btn.disabled = false;
                    }
                    // Update the key status display
                    checkKeyStatus();
                } else {
                    if (status) {
                        status.style.color = '#ff6b6b';
                        status.textContent = '‚úó ' + data.error;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Generate Domain Keys';
                    }
                }
            } catch (error) {
                if (status) {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó Request failed: ' + error.message;
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Generate Domain Keys';
                }
            }
        }

        async function registerDomain() {
            // Get buttons from both views
            const btn = document.getElementById('registerDomainBtn') || document.getElementById('registerDomainBtnSetup');
            const status = document.getElementById('registerDomainStatus') || document.getElementById('registerDomainStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Registering...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Contacting Tesla...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_register_partner") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (status) {
                        status.style.color = '#51cf66';
                        if (data.already_registered) {
                            status.textContent = '‚úì ' + data.message;
                        } else {
                            status.textContent = '‚úì ' + data.message + ' - API should now work!';
                        }
                    }
                    if (btn) btn.textContent = 'Domain Registered ‚úì';
                } else {
                    if (status) {
                        status.style.color = '#ff6b6b';
                        status.textContent = '‚úó ' + data.error;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Register Domain with Tesla';
                    }
                }
            } catch (error) {
                if (status) {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó Request failed: ' + error.message;
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Register Domain with Tesla';
                }
            }
        }

        function toggleAemoFields(enabled) {
            const fields = document.getElementById('aemo-fields');
            if (enabled) {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        }

        function toggleVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';  // Eye with slash (hidden)
                button.style.opacity = '1';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';  // Eye (visible)
                button.style.opacity = '0.6';
            }
        }

        // Initialize all secure fields as password type on page load
        document.addEventListener('DOMContentLoaded', function() {
            const secureFields = document.querySelectorAll('.secure-field');
            secureFields.forEach(field => {
                field.type = 'password';
            });
        });
    </script>
{% endblock settings_content %}
