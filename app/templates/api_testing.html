{% extends "settings_base.html" %}

{% block settings_content %}
<hgroup>
    <h1>API</h1>
    <h2>Mobile app access, connection status, and endpoint testing</h2>
</hgroup>

<!-- Mobile App API Token -->
<article>
    <header><strong>Mobile App Access</strong></header>
    <p style="font-size: 0.9em;">Generate an API token to connect the PowerSync mobile app.</p>

    <div id="battery-health-token-section">
        {% if current_user.battery_health_api_token %}
        <div style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin-bottom: 1em;">
            <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>API Token Active</strong></p>
            <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">
                Token: <code id="battery-health-token" style="font-size: 0.8em;">{{ current_user.battery_health_api_token[:8] }}...{{ current_user.battery_health_api_token[-4:] }}</code>
                <button type="button" onclick="copyBatteryHealthToken()" style="margin-left: 0.5em; padding: 0.2em 0.5em; font-size: 0.8em;">Copy Full Token</button>
            </p>
        </div>

        <div style="display: flex; gap: 0.5em;">
            <button type="button" onclick="regenerateBatteryHealthToken()" class="outline" style="flex: 1;">
                Regenerate Token
            </button>
            <button type="button" onclick="revokeBatteryHealthToken()" class="outline secondary" style="flex: 1;">
                Revoke Token
            </button>
        </div>
        {% else %}
        <div style="padding: 0.8em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin-bottom: 1em;">
            <p style="margin: 0; color: #999; font-size: 0.9em;">‚≠ï <strong>No API Token</strong></p>
            <p style="margin: 0.3em 0 0 0; font-size: 0.8em;">Generate a token to connect the mobile app.</p>
        </div>

        <button type="button" onclick="generateBatteryHealthToken()" class="outline primary" style="width: 100%;">
            Generate API Token
        </button>
        {% endif %}
    </div>

    <p id="battery-health-token-status" style="font-size: 0.8em; margin-top: 0.5em; display: none;"></p>

    <details style="margin-top: 1em;">
        <summary style="font-size: 0.85em;">Mobile App Setup</summary>
        <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 150, 0.05); border-radius: 0.3em;">
            <ol style="margin: 0.3em 0 0 1.2em; padding: 0;">
                <li style="margin: 0.3em 0;">Install the PowerSync app on your iPhone</li>
                <li style="margin: 0.3em 0;">Open Settings in the app</li>
                <li style="margin: 0.3em 0;">Enter your server URL and the API token above</li>
                <li style="margin: 0.3em 0;">Use "Fetch from Cloud" to get actual battery capacity</li>
            </ol>
        </div>
    </details>
</article>

<!-- Quick Stats Dashboard -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">Current Price</h4>
        <p id="stat-current-price" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small id="stat-price-trend" style="color: var(--muted-color);">Loading...</small>
    </article>
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">Renewables</h4>
        <p id="stat-renewables" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small style="color: var(--muted-color);">% Green Energy</small>
    </article>
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">Next Hour Avg</h4>
        <p id="stat-next-hour" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small style="color: var(--muted-color);">¬¢/kWh</small>
    </article>
    <article style="padding: 1rem; text-align: center;">
        <h4 style="margin: 0; font-size: 0.85em; color: var(--muted-color);">24h Range</h4>
        <p id="stat-price-range" style="margin: 0.5em 0; font-size: 1.8em; font-weight: bold;">--</p>
        <small style="color: var(--muted-color);">Min - Max</small>
    </article>
</div>

<!-- API Connection Status -->
<article id="connection-status">
    <header><strong>Connection Status</strong></header>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
        <div id="amber-status" style="padding: 1rem; border-radius: 0.5rem; background: rgba(150, 150, 150, 0.1);">
            <h4 style="margin: 0 0 0.5em 0;">‚ö° Amber REST API</h4>
            <div id="amber-status-content">
                <p style="margin: 0;">Checking connection...</p>
            </div>
        </div>
        <div id="websocket-status" style="padding: 1rem; border-radius: 0.5rem; background: rgba(150, 150, 150, 0.1);">
            <h4 style="margin: 0 0 0.5em 0;">üîå Amber WebSocket</h4>
            <div id="websocket-status-content">
                <p style="margin: 0;">Checking connection...</p>
            </div>
        </div>
        <div id="tesla-status" style="padding: 1rem; border-radius: 0.5rem; background: rgba(150, 150, 150, 0.1);">
            <h4 style="margin: 0 0 0.5em 0;">üîã Tesla Energy</h4>
            <div id="tesla-status-content">
                <p style="margin: 0;">Checking connection...</p>
            </div>
        </div>
    </div>
    <button onclick="refreshStatus()" style="margin-top: 1rem; width: auto;" class="outline">Refresh All Status</button>
</article>

<!-- Quick Actions -->
<article>
    <header><strong>Quick Actions</strong></header>
    <p style="font-size: 0.85em; margin-bottom: 1em;">Common scenarios and diagnostics at a glance</p>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button onclick="quickAction('current-situation')" class="contrast">üìä Current Situation</button>
        <button onclick="quickAction('next-24h-forecast')" class="contrast">üìà Next 24h Forecast</button>
        <button onclick="quickAction('optimal-times')" class="contrast">‚ö° Best Charge/Export Times</button>
        <button onclick="quickAction('tesla-battery')" class="contrast">üîã Battery Status</button>
        <button onclick="quickAction('tesla-tou')" class="contrast">‚è∞ Current TOU Schedule</button>
        <button onclick="quickAction('sync-test')" class="contrast">üîÑ Test Full Sync</button>
    </div>
    <div id="quick-action-result" style="margin-top: 1rem; display: none;">
        <details open>
            <summary id="quick-action-title">Results</summary>
            <div id="quick-action-content" style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                <pre id="quick-action-output" style="margin: 0; white-space: pre-wrap;"></pre>
            </div>
        </details>
    </div>
</article>

<!-- Tesla API Testing -->
<details>
    <summary><strong>üîã Tesla Energy API Endpoints</strong></summary>
    <div style="margin-top: 1rem;">
        <article>
            <h4>Site Info</h4>
            <button onclick="testTeslaEndpoint('site-info')" class="contrast">GET Site Information</button>
            <details id="response-tesla-site-info">
                <summary>Response</summary>
                <pre><code id="output-tesla-site-info">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Live Status</h4>
            <button onclick="testTeslaEndpoint('live-status')" class="contrast">GET Live Battery & Power Status</button>
            <details id="response-tesla-live-status">
                <summary>Response</summary>
                <pre><code id="output-tesla-live-status">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>TOU Schedule</h4>
            <button onclick="testTeslaEndpoint('tou-schedule')" class="contrast">GET Current TOU Schedule</button>
            <details id="response-tesla-tou">
                <summary>Response</summary>
                <pre><code id="output-tesla-tou">Click the button to test this endpoint</code></pre>
            </details>
        </article>
    </div>
</details>

<!-- Amber API Testing -->
<details open>
    <summary><strong>‚ö° Amber Electric API Endpoints</strong></summary>
    <div style="margin-top: 1rem;">
        <article>
            <h4>Sites</h4>
            <button onclick="testEndpoint('sites')" class="contrast">GET /v1/sites</button>
            <details id="response-sites">
                <summary>Response</summary>
                <pre><code id="output-sites">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Current Prices</h4>
            <button onclick="testEndpoint('current-prices')" class="contrast">GET /v1/sites/{site_id}/prices/current</button>
            <details id="response-current-prices">
                <summary>Response</summary>
                <pre><code id="output-current-prices">Click the button to test this endpoint</code></pre>
            </details>
        </article>

        <article>
            <h4>Price Forecast</h4>
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
                <select id="forecast-hours" style="width: auto;">
                    <option value="24">24 hours</option>
                    <option value="48">48 hours</option>
                    <option value="12">12 hours</option>
                </select>
                <select id="forecast-resolution" style="width: auto;">
                    <option value="30">30-min resolution</option>
                    <option value="5">5-min resolution</option>
                </select>
                <button onclick="testForecast()" class="contrast" style="margin: 0;">GET Forecast</button>
            </div>
            <details id="response-price-forecast">
                <summary>Response</summary>
                <pre><code id="output-price-forecast">Select options and click GET Forecast</code></pre>
            </details>
        </article>

        <article style="border: 2px solid var(--primary); background-color: var(--card-background-color);">
            <h4>Advanced Price Schema (ML predictions)</h4>
            <p style="font-size: 0.85em;">Shows <code>advancedPrice.predicted</code> field used in TOU tariff conversion.</p>
            <button onclick="testAdvancedPriceSchema()" class="contrast">GET Advanced Price Schema</button>
            <details id="response-advanced-price">
                <summary>Response (with Advanced Price breakdown)</summary>
                <pre><code id="output-advanced-price">Click the button to see the advanced price structure</code></pre>
            </details>
        </article>

        <article>
            <h4>Usage History (Last 7 days)</h4>
            <button onclick="testEndpoint('usage')" class="contrast">GET /v1/sites/{site_id}/usage</button>
            <details id="response-usage">
                <summary>Response</summary>
                <pre><code id="output-usage">Click the button to test this endpoint</code></pre>
            </details>
        </article>
    </div>
</details>

<!-- Developer Tools (collapsed by default) -->
<details>
    <summary><strong>üîß Developer Tools</strong></summary>
    <div style="margin-top: 1rem;">

        <!-- Custom Raw API Call -->
        <article>
            <h4>Custom Raw API Call</h4>
            <form id="raw-api-form" onsubmit="testRawEndpoint(event)">
                <div style="display: flex; gap: 0.5rem; align-items: end; flex-wrap: wrap;">
                    <label style="flex: 1; min-width: 200px;">
                        Endpoint Path
                        <input type="text" id="raw-endpoint" name="endpoint" placeholder="/sites" value="/sites" style="margin: 0;">
                    </label>
                    <label style="width: auto;">
                        Method
                        <select id="raw-method" name="method" style="margin: 0;">
                            <option value="GET" selected>GET</option>
                            <option value="POST">POST</option>
                        </select>
                    </label>
                    <button type="submit" class="contrast" style="margin: 0;">Execute</button>
                </div>
            </form>
            <details id="response-raw">
                <summary>Response</summary>
                <pre><code id="output-raw">Submit the form to test a custom endpoint</code></pre>
            </details>
        </article>

        <!-- WebSocket Debug Info -->
        <article>
            <h4>WebSocket Health Check</h4>
            <button onclick="testWebSocketHealth()" class="contrast">Get Detailed WebSocket Status</button>
            <details id="response-websocket-health">
                <summary>WebSocket Details</summary>
                <pre><code id="output-websocket-health">Click the button to check WebSocket health</code></pre>
            </details>
        </article>

    </div>
</details>

<script>
// Load initial data on page load
window.addEventListener('DOMContentLoaded', async () => {
    await refreshStatus();
    await loadQuickStats();
});

// Refresh connection status
async function refreshStatus() {
    try {
        // Fetch both API status and WebSocket status in parallel
        const [apiResponse, wsResponse] = await Promise.all([
            fetch('/api/status'),
            fetch('/api/websocket/status')
        ]);
        const data = await apiResponse.json();
        const wsData = await wsResponse.json();

        // Update Amber REST API status
        const amberDiv = document.getElementById('amber-status');
        const amberContent = document.getElementById('amber-status-content');
        if (data.amber && data.amber.connected) {
            amberDiv.style.background = 'rgba(0, 255, 0, 0.1)';
            amberContent.innerHTML = `
                <p style="margin: 0; color: var(--ins-color); font-weight: bold;">‚úì Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.amber.message}</p>
            `;
        } else {
            amberDiv.style.background = 'rgba(255, 0, 0, 0.1)';
            amberContent.innerHTML = `
                <p style="margin: 0; color: var(--del-color); font-weight: bold;">‚úó Not Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.amber.message || 'Not configured'}</p>
            `;
        }

        // Update WebSocket status
        const wsDiv = document.getElementById('websocket-status');
        const wsContent = document.getElementById('websocket-status-content');
        if (wsData.connected) {
            wsDiv.style.background = 'rgba(0, 255, 0, 0.1)';
            let wsDetails = `<p style="margin: 0; color: var(--ins-color); font-weight: bold;">‚úì Connected</p>`;
            wsDetails += `<p style="margin: 0.5em 0 0 0; font-size: 0.85em;">Messages: ${wsData.message_count}`;
            if (wsData.age_seconds !== null) {
                wsDetails += ` | Last: ${wsData.age_seconds}s ago`;
            }
            wsDetails += `</p>`;
            if (wsData.has_cached_data) {
                wsDetails += `<p style="margin: 0.3em 0 0 0; font-size: 0.8em; color: var(--ins-color);">Has cached price data</p>`;
            }
            wsContent.innerHTML = wsDetails;
        } else if (wsData.available) {
            wsDiv.style.background = 'rgba(255, 165, 0, 0.1)';
            let statusText = wsData.status === 'reconnecting' ? 'Reconnecting...' : 'Disconnected';
            wsContent.innerHTML = `
                <p style="margin: 0; color: orange; font-weight: bold;">‚ö† ${statusText}</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">Messages: ${wsData.message_count} | Errors: ${wsData.error_count}</p>
                ${wsData.last_error ? `<p style="margin: 0.3em 0 0 0; font-size: 0.8em; color: var(--del-color);">Last error: ${wsData.last_error.substring(0, 50)}...</p>` : ''}
            `;
        } else {
            wsDiv.style.background = 'rgba(150, 150, 150, 0.1)';
            wsContent.innerHTML = `
                <p style="margin: 0; color: var(--muted-color); font-weight: bold;">‚óã Not Initialized</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${wsData.message || 'Configure Amber credentials'}</p>
            `;
        }

        // Update Tesla status
        const teslaDiv = document.getElementById('tesla-status');
        const teslaContent = document.getElementById('tesla-status-content');
        if (data.tesla && data.tesla.connected) {
            teslaDiv.style.background = 'rgba(0, 255, 0, 0.1)';
            teslaContent.innerHTML = `
                <p style="margin: 0; color: var(--ins-color); font-weight: bold;">‚úì Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.tesla.message}</p>
            `;
        } else {
            teslaDiv.style.background = 'rgba(255, 0, 0, 0.1)';
            teslaContent.innerHTML = `
                <p style="margin: 0; color: var(--del-color); font-weight: bold;">‚úó Not Connected</p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">${data.tesla.message || 'Not configured'}</p>
            `;
        }
    } catch (error) {
        console.error('Error checking connection:', error);
    }
}

// Load quick stats for dashboard
async function loadQuickStats() {
    try {
        const response = await fetch('/api/amber/current-price');
        const data = await response.json();

        if (data && data.length > 0) {
            const general = data.find(p => p.channelType === 'general');
            if (general) {
                // Current price
                document.getElementById('stat-current-price').textContent = `${general.perKwh.toFixed(2)}¬¢`;
                document.getElementById('stat-price-trend').textContent = general.spikeStatus || 'Normal';

                // Renewables
                if (general.renewables !== undefined) {
                    document.getElementById('stat-renewables').textContent = `${general.renewables}%`;
                }
            }
        }

        // Get forecast for next hour and 24h range
        const forecastResponse = await fetch('/api/test/amber/price-forecast?next_hours=24&resolution=30');
        const forecastData = await forecastResponse.json();

        if (forecastData && forecastData.data) {
            const prices = forecastData.data
                .filter(p => p.channelType === 'general')
                .map(p => p.perKwh);

            if (prices.length > 2) {
                // Next hour average (next 2x 30-min periods)
                const nextHourAvg = (prices[0] + prices[1]) / 2;
                document.getElementById('stat-next-hour').textContent = nextHourAvg.toFixed(2);

                // 24h range
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                document.getElementById('stat-price-range').textContent = `${min.toFixed(1)} - ${max.toFixed(1)}`;
            }
        }
    } catch (error) {
        console.error('Error loading quick stats:', error);
    }
}

// Quick Actions
async function quickAction(action) {
    const resultDiv = document.getElementById('quick-action-result');
    const titleElem = document.getElementById('quick-action-title');
    const outputElem = document.getElementById('quick-action-output');

    resultDiv.style.display = 'block';
    outputElem.textContent = 'Loading...';

    try {
        switch (action) {
            case 'current-situation':
                titleElem.textContent = 'üìä Current Situation';
                const currentResp = await fetch('/api/amber/current-price');
                const currentData = await currentResp.json();
                const general = currentData.find(p => p.channelType === 'general');
                const feedIn = currentData.find(p => p.channelType === 'feedIn');

                let output = '=== CURRENT ELECTRICITY SITUATION ===\n\n';
                if (general) {
                    output += `Import Price: ${general.perKwh.toFixed(2)}¬¢/kWh\n`;
                    output += `Spike Status: ${general.spikeStatus || 'Normal'}\n`;
                    output += `Renewables: ${general.renewables}%\n`;
                }
                if (feedIn) {
                    output += `\nExport Price: ${feedIn.perKwh.toFixed(2)}¬¢/kWh\n`;
                }
                outputElem.textContent = output;
                break;

            case 'next-24h-forecast':
                titleElem.textContent = 'üìà Next 24h Forecast';
                const forecastResp = await fetch('/api/test/amber/price-forecast?next_hours=24&resolution=30');
                const forecastData = await forecastResp.json();

                const prices = forecastData.data.filter(p => p.channelType === 'general');
                let forecastOutput = '=== NEXT 24 HOURS PRICE FORECAST ===\n\n';
                prices.slice(0, 10).forEach(p => {
                    forecastOutput += `${p.period}: ${p.perKwh.toFixed(2)}¬¢/kWh\n`;
                });
                forecastOutput += `\n... and ${prices.length - 10} more periods\n`;
                outputElem.textContent = forecastOutput;
                break;

            case 'optimal-times':
                titleElem.textContent = '‚ö° Best Charge/Export Times';
                const optResp = await fetch('/api/test/amber/price-forecast?next_hours=24&resolution=30');
                const optData = await optResp.json();

                const importPrices = optData.data.filter(p => p.channelType === 'general');
                const exportPrices = optData.data.filter(p => p.channelType === 'feedIn');

                const sortedImport = [...importPrices].sort((a, b) => a.perKwh - b.perKwh);
                const sortedExport = [...exportPrices].sort((a, b) => b.perKwh - a.perKwh);

                let optOutput = '=== OPTIMAL TIMES (Next 24h) ===\n\n';
                optOutput += 'Best Times to CHARGE (Cheapest Import):\n';
                sortedImport.slice(0, 5).forEach((p, i) => {
                    optOutput += `${i+1}. ${p.period}: ${p.perKwh.toFixed(2)}¬¢/kWh\n`;
                });

                optOutput += '\nBest Times to EXPORT (Highest Feed-In):\n';
                sortedExport.slice(0, 5).forEach((p, i) => {
                    optOutput += `${i+1}. ${p.period}: ${p.perKwh.toFixed(2)}¬¢/kWh\n`;
                });
                outputElem.textContent = optOutput;
                break;

            case 'tesla-battery':
                titleElem.textContent = 'üîã Battery Status';
                const batteryResp = await fetch('/api/tesla/status');
                const batteryData = await batteryResp.json();

                let batteryOutput = '=== TESLA BATTERY STATUS ===\n\n';
                if (batteryData.error) {
                    batteryOutput += `Error: ${batteryData.error}\n`;
                } else {
                    batteryOutput += JSON.stringify(batteryData, null, 2);
                }
                outputElem.textContent = batteryOutput;
                break;

            case 'tesla-tou':
                titleElem.textContent = '‚è∞ Current TOU Schedule';
                const touResp = await fetch('/api/tou-schedule');
                const touData = await touResp.json();

                let touOutput = '=== CURRENT TOU SCHEDULE ON TESLA ===\n\n';
                touOutput += JSON.stringify(touData, null, 2);
                outputElem.textContent = touOutput;
                break;

            case 'sync-test':
                titleElem.textContent = 'üîÑ Full Sync Test';
                outputElem.textContent = 'Full sync test not implemented yet.\nThis would test the complete Amber‚ÜíTesla sync flow.';
                break;

            default:
                outputElem.textContent = 'Unknown action';
        }
    } catch (error) {
        outputElem.textContent = `Error: ${error.message}`;
    }
}

// Tesla API Endpoints
async function testTeslaEndpoint(name) {
    const outputElement = document.getElementById(`output-tesla-${name}`);
    const detailsElement = document.getElementById(`response-tesla-${name}`);

    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        let url;
        switch (name) {
            case 'site-info':
                url = '/api/tesla/status';
                break;
            case 'live-status':
                url = '/api/tesla/status';
                break;
            case 'tou-schedule':
                url = '/api/tou-schedule';
                break;
            default:
                throw new Error('Unknown Tesla endpoint');
        }

        const response = await fetch(url);
        const data = await response.json();

        outputElement.textContent = JSON.stringify(data, null, 2);
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

// Amber API Endpoints
async function testEndpoint(name, params = {}) {
    const outputElement = document.getElementById(`output-${name}`);
    const detailsElement = document.getElementById(`response-${name}`);

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        let url;
        switch (name) {
            case 'sites':
                url = '/api/test/amber/sites';
                break;
            case 'current-prices':
                url = '/api/test/amber/current-prices';
                break;
            case 'price-forecast':
            case 'price-forecast-48h':
            case 'price-forecast-5min':
            case 'price-forecast-30min':
                const queryParams = new URLSearchParams(params).toString();
                url = `/api/test/amber/price-forecast?${queryParams}`;
                break;
            case 'usage':
                url = '/api/test/amber/usage';
                break;
            default:
                throw new Error('Unknown endpoint');
        }

        const response = await fetch(url);
        const data = await response.json();

        // Pretty print JSON with metadata
        let output = `Endpoint: ${data.endpoint || 'N/A'}\n`;
        if (data.count !== undefined) {
            output += `Count: ${data.count} records\n`;
        }
        output += `Status: ${response.status}\n\n`;
        output += `Response:\n${JSON.stringify(data.data, null, 2)}`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

// Consolidated Forecast test
async function testForecast() {
    const hours = document.getElementById('forecast-hours').value;
    const resolution = document.getElementById('forecast-resolution').value;

    const outputElement = document.getElementById('output-price-forecast');
    const detailsElement = document.getElementById('response-price-forecast');

    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        const url = `/api/test/amber/price-forecast?next_hours=${hours}&resolution=${resolution}`;
        const response = await fetch(url);
        const data = await response.json();

        let output = `Endpoint: ${data.endpoint || 'N/A'}\n`;
        output += `Parameters: next_hours=${hours}, resolution=${resolution}\n`;
        if (data.count !== undefined) {
            output += `Count: ${data.count} records\n`;
        }
        output += `Status: ${response.status}\n\n`;
        output += `Response:\n${JSON.stringify(data.data, null, 2)}`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testAdvancedPriceSchema() {
    const outputElement = document.getElementById('output-advanced-price');
    const detailsElement = document.getElementById('response-advanced-price');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        // Fetch 30-minute forecast data which includes advanced price schema
        const response = await fetch('/api/test/amber/advanced-price-schema');
        const data = await response.json();

        if (!data.success) {
            outputElement.textContent = `Error: ${data.error}`;
            return;
        }

        // Format the output to highlight the advanced price structure
        let output = `Endpoint: ${data.endpoint}\n`;
        output += `Records: ${data.count}\n`;
        output += `Status: ${response.status}\n\n`;

        output += `=== ADVANCED PRICE STRUCTURE ===\n\n`;

        if (data.sample) {
            output += `Sample Record (First 30-min interval):\n`;
            output += `Period: ${data.sample.period}\n`;
            output += `Channel Type: ${data.sample.channelType}\n`;
            output += `Spike Status: ${data.sample.spikeStatus}\n\n`;

            output += `--- Base Price Fields ---\n`;
            output += `per_kwh: ${data.sample.perKwh} c/kWh\n`;
            output += `spot_per_kwh: ${data.sample.spotPerKwh} c/kWh\n\n`;

            if (data.sample.advancedPrice) {
                output += `--- Advanced Price Object (ML Forecast) ---\n`;
                output += JSON.stringify(data.sample.advancedPrice, null, 2);
                output += `\n\n`;
                output += `Key Fields Explained:\n`;
                output += `‚Ä¢ predicted: ML-predicted price (used by SmartShift)\n`;
                output += `‚Ä¢ actual: Actual measured price (null for future intervals)\n`;
                output += `‚Ä¢ renewables: Percentage of renewable energy\n`;
                output += `‚Ä¢ channelType: 'general' (import) or 'feedIn' (export)\n`;
            }
        }

        output += `\n\n=== FULL API RESPONSE (ALL RECORDS) ===\n\n`;
        output += JSON.stringify(data.data, null, 2);

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

// WebSocket Health Check
async function testWebSocketHealth() {
    const outputElement = document.getElementById('output-websocket-health');
    const detailsElement = document.getElementById('response-websocket-health');

    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/websocket/status');
        const data = await response.json();

        let output = `=== WEBSOCKET HEALTH STATUS ===\n\n`;
        output += `Available: ${data.available ? 'Yes' : 'No'}\n`;
        output += `Connection Status: ${data.status}\n`;
        output += `Connected: ${data.connected ? 'Yes' : 'No'}\n\n`;

        if (data.available) {
            output += `--- STATISTICS ---\n`;
            output += `Messages Received: ${data.message_count}\n`;
            output += `Errors: ${data.error_count}\n`;
            output += `Has Cached Data: ${data.has_cached_data ? 'Yes' : 'No'}\n`;

            if (data.last_update) {
                output += `\n--- LAST UPDATE ---\n`;
                output += `Timestamp: ${data.last_update}\n`;
                output += `Age: ${data.age_seconds}s ago\n`;
            }

            if (data.last_error) {
                output += `\n--- LAST ERROR ---\n`;
                output += `${data.last_error}\n`;
            }
        } else {
            output += `Message: ${data.message}\n`;
        }

        output += `\n\n--- RAW RESPONSE ---\n`;
        output += JSON.stringify(data, null, 2);

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

async function testRawEndpoint(event) {
    event.preventDefault();

    const endpoint = document.getElementById('raw-endpoint').value;
    const method = document.getElementById('raw-method').value;
    const outputElement = document.getElementById('output-raw');
    const detailsElement = document.getElementById('response-raw');

    // Show loading state
    outputElement.textContent = 'Loading...';
    detailsElement.open = true;

    try {
        const response = await fetch('/api/test/amber/raw', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                endpoint: endpoint,
                method: method
            })
        });

        const data = await response.json();

        // Pretty print JSON with metadata
        let output = `Endpoint: ${data.endpoint || 'N/A'}\n`;
        output += `HTTP Status: ${data.status_code || response.status}\n`;
        output += `Success: ${data.success ? 'Yes' : 'No'}\n\n`;
        output += `Response:\n${JSON.stringify(data.data, null, 2)}`;

        outputElement.textContent = output;
    } catch (error) {
        outputElement.textContent = `Error: ${error.message}`;
    }
}

// Battery Health Token Management
async function generateBatteryHealthToken() {
    const status = document.getElementById('battery-health-token-status');
    status.style.display = 'block';
    status.innerHTML = '<span style="color: #fcc419;">Generating token...</span>';

    try {
        const response = await fetch('/api/battery-health/generate-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.token) {
            status.innerHTML = '<span style="color: #51cf66;">‚úì Token generated! Copy it now - it won\'t be shown again in full.</span>';
            setTimeout(() => location.reload(), 1500);
        } else {
            status.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + (data.error || 'Failed to generate token') + '</span>';
        }
    } catch (error) {
        status.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + error.message + '</span>';
    }
}

async function regenerateBatteryHealthToken() {
    if (!confirm('Regenerate API token? The old token will stop working immediately.')) {
        return;
    }
    await generateBatteryHealthToken();
}

async function revokeBatteryHealthToken() {
    if (!confirm('Revoke API token? The mobile app will no longer be able to connect.')) {
        return;
    }

    const status = document.getElementById('battery-health-token-status');
    status.style.display = 'block';
    status.innerHTML = '<span style="color: #fcc419;">Revoking token...</span>';

    try {
        const response = await fetch('/api/battery-health/revoke-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.success) {
            status.innerHTML = '<span style="color: #51cf66;">‚úì Token revoked</span>';
            setTimeout(() => location.reload(), 1000);
        } else {
            status.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + (data.error || 'Failed to revoke token') + '</span>';
        }
    } catch (error) {
        status.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + error.message + '</span>';
    }
}

async function copyBatteryHealthToken() {
    const status = document.getElementById('battery-health-token-status');
    status.style.display = 'block';
    status.innerHTML = '<span style="color: #fcc419;">Fetching token...</span>';

    try {
        const response = await fetch('/api/battery-health/generate-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.token) {
            await navigator.clipboard.writeText(data.token);
            status.innerHTML = '<span style="color: #51cf66;">‚úì Token copied to clipboard!</span>';
        } else {
            status.innerHTML = '<span style="color: #ff6b6b;">‚úó Could not fetch token</span>';
        }
    } catch (error) {
        status.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + error.message + '</span>';
    }
}
</script>

<style>
pre {
    background-color: var(--card-background-color);
    padding: 1rem;
    border-radius: var(--border-radius);
    overflow-x: auto;
    max-height: 500px;
    overflow-y: auto;
}

code {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
}

details {
    margin-top: 1rem;
}

article {
    margin-bottom: 2rem;
}

button {
    margin-bottom: 1rem;
}
</style>
{% endblock settings_content %}
