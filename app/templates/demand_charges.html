{% extends "settings_base.html" %}

{% block settings_content %}
    <hgroup>
        <h1>Demand Charges & Daily Supply Charges</h1>
        <h2>Configure demand charge periods and fixed daily charges</h2>
    </hgroup>

    <!-- Explanation Article -->
    <article>
        <header><strong>About These Charges</strong></header>
        <p style="font-size: 0.9em;">
            <strong>Demand charges</strong> are fees based on your peak power usage (measured in kW) during specific time periods.
            These are separate from energy charges (which are based on total kWh consumed). Configure demand charges
            to help Tesla optimize when to charge and discharge your battery.
        </p>
        <p style="font-size: 0.9em;">
            <strong>Daily supply charges</strong> are fixed daily and monthly fees that appear on your electricity bill.
            These include network access charges, metering fees, and monthly account fees. Configure these for
            accurate cost tracking in Home Assistant.
        </p>
    </article>

    <!-- Configuration Form -->
    <article>
        <header><strong>Demand Charge Configuration</strong></header>

        <form action="{{ url_for('main.demand_charges') }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            <!-- Enable/Disable -->
            <fieldset>
                <label for="enable_demand_charges">
                    <input type="checkbox" id="enable_demand_charges" name="enable_demand_charges"
                           {% if form.enable_demand_charges.data %}checked{% endif %}
                           onchange="toggleDemandFields(this.checked)">
                    Enable Demand Charges
                </label>
            </fieldset>

            <div id="demand-fields" style="{% if not form.enable_demand_charges.data %}display: none;{% endif %}">
                <!-- Peak Period -->
                <fieldset style="margin-top: 1em; padding: 1em; background: rgba(255, 100, 100, 0.05); border-radius: 0.5em;">
                    <legend><strong>Peak Demand Period</strong></legend>

                    <label for="peak_rate">
                        {{ form.peak_rate.label }}
                        <small>Rate charged per kW of peak demand during this period</small>
                        {{ form.peak_rate(placeholder="0.0000") }}
                    </label>

                    <div class="grid" style="margin-top: 0.5em;">
                        <div>
                            <label for="peak_start_hour">
                                Start Time (Hour)
                                {{ form.peak_start_hour(placeholder="14") }}
                            </label>
                        </div>
                        <div>
                            <label for="peak_start_minute">
                                Start Time (Minute)
                                {{ form.peak_start_minute(placeholder="0") }}
                            </label>
                        </div>
                    </div>

                    <div class="grid" style="margin-top: 0.5em;">
                        <div>
                            <label for="peak_end_hour">
                                End Time (Hour)
                                {{ form.peak_end_hour(placeholder="20") }}
                            </label>
                        </div>
                        <div>
                            <label for="peak_end_minute">
                                End Time (Minute)
                                {{ form.peak_end_minute(placeholder="0") }}
                            </label>
                        </div>
                    </div>

                    <label for="peak_days" style="margin-top: 0.5em;">
                        Apply to Days
                        {{ form.peak_days }}
                    </label>

                    <label for="demand_charge_apply_to" style="margin-top: 0.5em;">
                        {{ form.demand_charge_apply_to.label }}
                        <small>Choose whether demand charges apply to grid import (buy), solar export (sell), or both</small>
                        {{ form.demand_charge_apply_to }}
                    </label>
                </fieldset>

                <!-- Shoulder Period (Optional) -->
                <fieldset style="margin-top: 1em; padding: 1em; background: rgba(255, 200, 100, 0.05); border-radius: 0.5em;">
                    <legend><strong>Shoulder Demand Period (Optional)</strong></legend>

                    <label for="shoulder_rate">
                        {{ form.shoulder_rate.label }}
                        <small>Rate charged per kW during shoulder period (leave at 0 to disable)</small>
                        {{ form.shoulder_rate(placeholder="0.0000") }}
                    </label>

                    <div class="grid" style="margin-top: 0.5em;">
                        <div>
                            <label for="shoulder_start_hour">
                                Start Time (Hour)
                                {{ form.shoulder_start_hour(placeholder="7") }}
                            </label>
                        </div>
                        <div>
                            <label for="shoulder_start_minute">
                                Start Time (Minute)
                                {{ form.shoulder_start_minute(placeholder="0") }}
                            </label>
                        </div>
                    </div>

                    <div class="grid" style="margin-top: 0.5em;">
                        <div>
                            <label for="shoulder_end_hour">
                                End Time (Hour)
                                {{ form.shoulder_end_hour(placeholder="14") }}
                            </label>
                        </div>
                        <div>
                            <label for="shoulder_end_minute">
                                End Time (Minute)
                                {{ form.shoulder_end_minute(placeholder="0") }}
                            </label>
                        </div>
                    </div>
                </fieldset>

                <!-- Off-Peak Period -->
                <fieldset style="margin-top: 1em; padding: 1em; background: rgba(100, 255, 100, 0.05); border-radius: 0.5em;">
                    <legend><strong>Off-Peak Demand Period</strong></legend>

                    <label for="offpeak_rate">
                        {{ form.offpeak_rate.label }}
                        <small>Rate charged per kW during off-peak times (all times not in peak or shoulder)</small>
                        {{ form.offpeak_rate(placeholder="0.0000") }}
                    </label>
                </fieldset>
            </div>

            <!-- Daily Supply Charges (Optional) - Always visible -->
            <fieldset style="margin-top: 1em; padding: 1em; background: rgba(100, 200, 255, 0.05); border-radius: 0.5em;">
                <legend><strong>Daily Supply Charges (Optional)</strong></legend>

                <div role="alert" style="background: rgba(100, 200, 255, 0.1); padding: 0.75em; border-radius: 0.25em; margin-bottom: 1em; border-left: 4px solid #2196F3;">
                    <p style="font-size: 0.9em; margin: 0;">
                        <strong>Note for Amber users:</strong> Enter your daily supply charge here. While Amber's per-kWh rates include network usage fees, the fixed daily supply charges (network access + metering) are separate. Find your rate in the Amber app or on your bill.
                    </p>
                </div>

                <label for="daily_supply_charge">
                    {{ form.daily_supply_charge.label }}
                    <small>{{ form.daily_supply_charge.description }}</small>
                    {{ form.daily_supply_charge(placeholder="1.1770") }}
                </label>

                <label for="monthly_supply_charge" style="margin-top: 0.5em;">
                    {{ form.monthly_supply_charge.label }}
                    <small>{{ form.monthly_supply_charge.description }}</small>
                    {{ form.monthly_supply_charge(placeholder="0.00") }}
                </label>
            </fieldset>

            {{ form.submit(class_="primary", style="margin-top: 1em;") }}
        </form>
    </article>

    <!-- Current Configuration Display -->
    {% if current_user.enable_demand_charges %}
    <article>
        <header><strong>Current Demand Charge Configuration</strong></header>

        <p style="font-size: 0.9em;">
            <strong>Applies to:</strong>
            {% if current_user.demand_charge_apply_to == 'buy' %}
                Grid Import (Buy) only
            {% elif current_user.demand_charge_apply_to == 'sell' %}
                Solar Export (Sell) only
            {% elif current_user.demand_charge_apply_to == 'both' %}
                Both Grid Import and Solar Export
            {% else %}
                Grid Import (Buy) only (default)
            {% endif %}
        </p>

        <table role="grid">
            <thead>
                <tr>
                    <th>Period</th>
                    <th>Time Range</th>
                    <th>Rate ($/kW)</th>
                    <th>Days</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong style="color: #dc3545;">Peak</strong></td>
                    <td>{{ "%02d:%02d"|format(current_user.peak_start_hour, current_user.peak_start_minute) }} - {{ "%02d:%02d"|format(current_user.peak_end_hour, current_user.peak_end_minute) }}</td>
                    <td>${{ "%.4f"|format(current_user.peak_demand_rate) }}</td>
                    <td>{{ current_user.peak_days|capitalize }}</td>
                </tr>
                {% if current_user.shoulder_demand_rate and current_user.shoulder_demand_rate > 0 %}
                <tr>
                    <td><strong style="color: #fd7e14;">Shoulder</strong></td>
                    <td>{{ "%02d:%02d"|format(current_user.shoulder_start_hour, current_user.shoulder_start_minute) }} - {{ "%02d:%02d"|format(current_user.shoulder_end_hour, current_user.shoulder_end_minute) }}</td>
                    <td>${{ "%.4f"|format(current_user.shoulder_demand_rate) }}</td>
                    <td>All days</td>
                </tr>
                {% endif %}
                <tr>
                    <td><strong style="color: #28a745;">Off-Peak</strong></td>
                    <td>All other times</td>
                    <td>${{ "%.4f"|format(current_user.offpeak_demand_rate) }}</td>
                    <td>All days</td>
                </tr>
            </tbody>
        </table>
    </article>
    {% endif %}

    <!-- Daily Supply Charges Display - Always visible when configured -->
    {% if current_user.daily_supply_charge and current_user.daily_supply_charge > 0 or current_user.monthly_supply_charge and current_user.monthly_supply_charge > 0 %}
    <article>
        <header><strong>Current Daily Supply Charges</strong></header>
        <ul style="margin: 0.5em 0 0 0; padding-left: 1.5em;">
            {% if current_user.daily_supply_charge and current_user.daily_supply_charge > 0 %}
            <li>Daily Charge: ${{ "%.4f"|format(current_user.daily_supply_charge) }}/day</li>
            {% endif %}
            {% if current_user.monthly_supply_charge and current_user.monthly_supply_charge > 0 %}
            <li>Monthly Charge: ${{ "%.2f"|format(current_user.monthly_supply_charge) }}/month</li>
            {% endif %}
        </ul>
    </article>
    {% endif %}

    <script>
        function toggleDemandFields(enabled) {
            const fields = document.getElementById('demand-fields');
            if (enabled) {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        }
    </script>
{% endblock settings_content %}
