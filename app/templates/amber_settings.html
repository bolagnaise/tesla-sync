{% extends "settings_base.html" %}

{% block settings_content %}
    <hgroup>
        <h1>Amber Electric Settings</h1>
        <h2>Configure Amber-specific TOU tariff options</h2>
    </hgroup>

    <article>
        <header><strong>Amber Electric Configuration</strong></header>
        <p>These settings control how Amber Electric pricing forecasts are used for your TOU tariff sync.</p>

        <form action="{{ url_for('main.amber_settings') }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            {% if amber_sites %}
            <fieldset>
                <legend>Amber Site</legend>
                {% if amber_sites|length == 1 %}
                    {# Include hidden field so form validation passes #}
                    <input type="hidden" name="amber_site_id" value="{{ amber_sites[0]['id'] }}">
                    <label>
                        <strong>Your Amber Site:</strong> {{ amber_sites[0].get('nmi', amber_sites[0]['id']) }}
                        <small style="display: block; margin-top: 0.3em; color: var(--muted-color);">Only one site found - auto-selected</small>
                    </label>
                {% else %}
                    <label for="amber_site_id">
                        {{ form.amber_site_id.label }}
                        {{ form.amber_site_id(style="width: 100%;") }}
                        <small>{{ form.amber_site_id.description }}</small>
                    </label>
                {% endif %}
            </fieldset>
            {% endif %}

            <fieldset>
                <legend>Forecast Pricing Type</legend>
                <label for="amber_forecast_type">
                    {{ form.amber_forecast_type.label }}
                    {{ form.amber_forecast_type(style="width: 100%;") }}
                    <small>{{ form.amber_forecast_type.description }}</small>
                </label>
                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">What do these options mean?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>Predicted (Default):</strong> Uses Amber's best estimate for upcoming prices. Balanced approach.</li>
                            <li style="margin: 0.5em 0;"><strong>Low (Conservative):</strong> Uses the low-end forecast. Battery may charge more conservatively and discharge less aggressively.</li>
                            <li style="margin: 0.5em 0;"><strong>High (Optimistic):</strong> Uses the high-end forecast. Battery may charge more aggressively during predicted low prices and export more during predicted high prices.</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>Settled Prices Only</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Only sync prices after they've settled (actual prices), skipping the initial forecast sync.
                </p>

                <label for="settled_prices_only" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="settled_prices_only" name="settled_prices_only"
                           {% if current_user.settled_prices_only %}checked{% endif %}>
                    <span>Enable Settled Prices Only</span>
                </label>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">How does this work?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">By default, PowerSync syncs prices at the start of each 5-minute interval using Amber's forecast, then updates when actual prices arrive.</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>When disabled (default):</strong> Syncs forecast prices at :00, then updates with actual prices from WebSocket or REST API at :35/:60.</li>
                            <li style="margin: 0.5em 0;"><strong>When enabled:</strong> Skips the initial forecast sync. Only syncs when actual/settled prices arrive via WebSocket or REST API at :35/:60 seconds.</li>
                            <li style="margin: 0.5em 0;"><strong>Use case:</strong> If you notice the Powerwall making decisions based on forecast prices that differ from actual settled prices, enable this to only use settled data.</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>DC Solar Curtailment</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Automatically curtail solar export during negative feed-in prices. Works with both Tesla Powerwall and Sigenergy systems.
                </p>

                <label for="solar_curtailment_enabled" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="solar_curtailment_enabled" name="solar_curtailment_enabled"
                           {% if current_user.solar_curtailment_enabled %}checked{% endif %}
                           onchange="toggleSigenergyModbusConfig()">
                    <span>Enable DC Solar Curtailment</span>
                </label>

                {% if current_user.battery_system == 'sigenergy' %}
                <!-- Sigenergy Modbus Configuration -->
                <div id="sigenergyModbusConfig" style="margin-top: 1em; {% if not current_user.solar_curtailment_enabled %}display: none;{% endif %}">
                    <div style="padding: 0.8em; background: rgba(100, 150, 200, 0.1); border-radius: 0.5em; margin-bottom: 1em;">
                        <p style="margin: 0 0 0.5em 0; font-size: 0.85em;"><strong>Sigenergy Modbus TCP Settings</strong></p>
                        <p style="font-size: 0.8em; margin: 0; color: var(--muted-color);">
                            Configure Modbus connection to set export limit to 0kW during negative prices.
                        </p>
                    </div>

                    <label for="sigenergy_modbus_host">
                        Sigenergy IP Address
                        <input type="text" id="sigenergy_modbus_host" name="sigenergy_modbus_host"
                               value="{{ current_user.sigenergy_modbus_host or '' }}"
                               placeholder="192.168.1.100" style="width: 100%;">
                    </label>
                    <small style="display: block; margin-top: -0.5em; margin-bottom: 1em; color: var(--muted-color);">
                        Local IP address of your Sigenergy inverter
                    </small>

                    <div style="display: flex; gap: 1em;">
                        <div style="flex: 1;">
                            <label for="sigenergy_modbus_port">
                                Modbus Port
                                <input type="number" id="sigenergy_modbus_port" name="sigenergy_modbus_port"
                                       value="{{ current_user.sigenergy_modbus_port or 502 }}"
                                       min="1" max="65535" style="width: 100%;">
                            </label>
                            <small style="display: block; margin-top: -0.5em; color: var(--muted-color);">
                                Default: 502
                            </small>
                        </div>
                        <div style="flex: 1;">
                            <label for="sigenergy_modbus_slave_id">
                                Slave ID
                                <input type="number" id="sigenergy_modbus_slave_id" name="sigenergy_modbus_slave_id"
                                       value="{{ current_user.sigenergy_modbus_slave_id or 1 }}"
                                       min="1" max="247" style="width: 100%;">
                            </label>
                            <small style="display: block; margin-top: -0.5em; color: var(--muted-color);">
                                Default: 1
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">How does solar curtailment work?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">When enabled, this feature monitors Amber feed-in prices every minute and automatically:</p>
                        {% if current_user.battery_system == 'sigenergy' %}
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>During negative prices (‚â§0c/kWh):</strong> Sets Sigenergy export limit to 0kW via Modbus (load-following mode). Solar continues to power your home but won't export.</li>
                            <li style="margin: 0.5em 0;"><strong>During positive prices (>0c/kWh):</strong> Restores normal export limit to allow solar export to grid.</li>
                        </ul>
                        {% else %}
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>During negative prices (‚â§0c/kWh):</strong> Sets Powerwall export to "never" to prevent paying to export your solar to the grid.</li>
                            <li style="margin: 0.5em 0;"><strong>During positive prices (>0c/kWh):</strong> Restores export to "battery_ok" to allow both solar and battery export.</li>
                        </ul>
                        {% endif %}
                        <p style="margin: 0.5em 0 0 0; font-style: italic;">This is particularly useful with Amber's wholesale pricing to avoid financial penalties during negative price events.</p>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>AC-Coupled Inverter Curtailment</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Direct control of your solar inverter via Modbus TCP for AC-coupled systems. Works alongside Tesla curtailment above.
                </p>

                <label for="inverter_curtailment_enabled" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="inverter_curtailment_enabled" name="inverter_curtailment_enabled"
                           {% if current_user.inverter_curtailment_enabled %}checked{% endif %}
                           onchange="toggleInverterDetails()">
                    <span>Enable Direct Inverter Curtailment</span>
                </label>

                <div id="inverterDetails" style="margin-top: 1em; {% if not current_user.inverter_curtailment_enabled %}display: none;{% endif %}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                        <label for="inverter_brand">
                            <span>Inverter Brand</span>
                            <select id="inverter_brand" name="inverter_brand">
                                <option value="">Select brand...</option>
                                <option value="sungrow" {% if current_user.inverter_brand == 'sungrow' %}selected{% endif %}>Sungrow</option>
                                <option value="fronius" {% if current_user.inverter_brand == 'fronius' %}selected{% endif %}>Fronius</option>
                                <option value="goodwe" {% if current_user.inverter_brand == 'goodwe' %}selected{% endif %}>GoodWe</option>
                                <option value="huawei" {% if current_user.inverter_brand == 'huawei' %}selected{% endif %}>Huawei</option>
                                <option value="enphase" {% if current_user.inverter_brand == 'enphase' %}selected{% endif %}>Enphase</option>
                                <option value="zeversolar" {% if current_user.inverter_brand == 'zeversolar' %}selected{% endif %}>Zeversolar</option>
                            </select>
                        </label>
                        <label for="inverter_model">
                            <span>Inverter Model</span>
                            <select id="inverter_model" name="inverter_model">
                                <option value="">Select model...</option>
                                <!-- Models populated dynamically by JavaScript -->
                            </select>
                        </label>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1em; margin-top: 1em;">
                        <label for="inverter_host">
                            <span>IP Address / Hostname</span>
                            <input type="text" id="inverter_host" name="inverter_host"
                                   value="{{ current_user.inverter_host or '' }}"
                                   placeholder="192.168.1.100">
                        </label>
                        <label for="inverter_port">
                            <span>Port</span>
                            <input type="number" id="inverter_port" name="inverter_port"
                                   value="{{ current_user.inverter_port or 502 }}"
                                   min="1" max="65535">
                            <small id="portHint" style="font-size: 0.75em; color: var(--muted-color);">Modbus: 502, Enphase: 443</small>
                        </label>
                        <label for="inverter_slave_id" id="slaveIdLabel">
                            <span>Slave ID</span>
                            <input type="text" id="inverter_slave_id" name="inverter_slave_id"
                                   value="{{ current_user.inverter_slave_id or 1 }}"
                                   placeholder="1" inputmode="numeric" pattern="[0-9]*">
                            <small style="font-size: 0.75em; color: var(--muted-color);">GoodWe: 247, Others: 1</small>
                        </label>
                    </div>

                    <div style="margin-top: 1em;">
                        <button type="button" class="secondary" onclick="testInverterConnection()" id="testInverterBtn">
                            Test Connection
                        </button>
                        <button type="button" class="secondary" onclick="curtailInverter()" id="curtailInverterBtn" style="margin-left: 0.5em; background: #d9534f; border-color: #d9534f;">
                            üî¥ Curtail
                        </button>
                        <button type="button" class="secondary" onclick="restoreInverter()" id="restoreInverterBtn" style="margin-left: 0.5em; background: #5cb85c; border-color: #5cb85c;">
                            üü¢ Restore
                        </button>
                        <span id="inverterTestResult" style="margin-left: 1em; font-size: 0.9em;"></span>
                    </div>

                    <div style="margin-top: 1.5em; padding-top: 1em; border-top: 1px solid rgba(128,128,128,0.2);">
                        <label for="inverter_restore_soc">
                            <span>Restore SOC Threshold (%)</span>
                            <small style="display: block; margin-top: 0.2em; color: var(--muted-color);">Restore inverter when battery drops below this %. Default: 98%</small>
                            <input type="number" id="inverter_restore_soc" name="inverter_restore_soc"
                                   value="{{ current_user.inverter_restore_soc or 98 }}"
                                   min="50" max="100" step="1"
                                   style="width: 150px;">
                        </label>
                        <p style="font-size: 0.75em; margin: 0.5em 0 0 0; color: var(--muted-color);">
                            When battery SOC drops below this threshold, the inverter will be restored to allow solar production. Ensures battery stays topped up before evening peak.
                        </p>
                    </div>

                    {% if current_user.inverter_last_state %}
                    <p style="font-size: 0.8em; color: var(--muted-color); margin-top: 1em;">
                        Last state: <strong>{{ current_user.inverter_last_state }}</strong>
                        {% if current_user.inverter_last_state_updated %}
                        ({{ current_user.inverter_last_state_updated.strftime('%Y-%m-%d %H:%M:%S') }})
                        {% endif %}
                    </p>
                    {% endif %}
                </div>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">How does inverter curtailment work?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">For AC-coupled solar systems, the solar inverter feeds directly into your home AC, bypassing the Powerwall. This means Tesla's export rule doesn't stop your solar from exporting.</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>During negative prices (‚â§0c/kWh):</strong> Shuts down the inverter via Modbus TCP to stop solar production entirely.</li>
                            <li style="margin: 0.5em 0;"><strong>During positive prices (>0c/kWh):</strong> Restores the inverter to normal operation.</li>
                            <li style="margin: 0.5em 0;"><strong>Sungrow:</strong> Uses WiNet-S dongle for Modbus TCP communication.</li>
                        </ul>
                        <p style="margin: 0.5em 0 0 0; font-style: italic;">Uses the same price threshold as Tesla curtailment (< 1c/kWh export earnings).</p>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>Spike Protection</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Prevent Powerwall from charging from grid during Amber price spikes. Stops arbitrage behavior that would otherwise charge during high-cost spike periods.
                </p>

                <label for="spike_protection_enabled" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="spike_protection_enabled" name="spike_protection_enabled"
                           {% if current_user.spike_protection_enabled %}checked{% endif %}>
                    <span>Enable Spike Protection</span>
                </label>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">How does spike protection work?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">When Amber detects a price spike, the Powerwall may see an arbitrage opportunity and charge from grid. This defeats the purpose of avoiding high prices.</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>How it works:</strong> When Amber reports 'potential' or 'spike' status for a period, buy prices are overridden to max(sell) + $1/kWh - eliminating any arbitrage profit.</li>
                            <li style="margin: 0.5em 0;"><strong>Per-period:</strong> Only affects periods that Amber identifies as having spike status, not a fixed time window.</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>Export Price Boost</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Artificially increase export prices to trigger Powerwall exports. Useful when prices are in the 20-25c range where Tesla may not export.
                </p>

                <label for="export_boost_enabled" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="export_boost_enabled" name="export_boost_enabled"
                           {% if current_user.export_boost_enabled %}checked{% endif %}
                           onchange="toggleExportBoostDetails()">
                    <span>Enable Export Price Boost</span>
                </label>

                <div id="exportBoostDetails" style="margin-top: 1em; {% if not current_user.export_boost_enabled %}display: none;{% endif %}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                        <label for="export_price_offset">
                            Price Offset (c/kWh)
                            <small>Added to all export prices</small>
                            <input type="number" id="export_price_offset" name="export_price_offset"
                                   value="{{ current_user.export_price_offset or 0 }}"
                                   step="0.1" min="0" max="50"
                                   style="width: 100%;">
                        </label>

                        <label for="export_min_price">
                            Minimum Price (c/kWh)
                            <small>Floor for export prices</small>
                            <input type="number" id="export_min_price" name="export_min_price"
                                   value="{{ current_user.export_min_price or 0 }}"
                                   step="0.1" min="0" max="100"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <div style="margin-top: 1em;">
                        <label for="export_boost_threshold">
                            Activation Threshold (c/kWh)
                            <small>Boost won't apply if actual price is below this (0 = always apply)</small>
                            <input type="number" id="export_boost_threshold" name="export_boost_threshold"
                                   value="{{ current_user.export_boost_threshold or 0 }}"
                                   step="0.1" min="0" max="50"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-top: 1em;">
                        <label for="export_boost_start">
                            Boost Start Time
                            <small>When to start applying boost</small>
                            <input type="time" id="export_boost_start" name="export_boost_start"
                                   value="{{ current_user.export_boost_start or '17:00' }}"
                                   style="width: 100%;">
                        </label>

                        <label for="export_boost_end">
                            Boost End Time
                            <small>When to stop applying boost</small>
                            <input type="time" id="export_boost_end" name="export_boost_end"
                                   value="{{ current_user.export_boost_end or '21:00' }}"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <p style="font-size: 0.75em; margin: 1em 0 0 0; color: var(--muted-color);">
                        Example: With offset=5c, min=20c, threshold=10c: an 18c export becomes 23c (18+5). A 12c export becomes 20c (floor). A 5c export stays at 5c (below threshold, boost skipped).
                    </p>
                </div>
                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">When should I use this?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">Tesla Powerwalls may not export when prices are below ~25c/kWh. This feature boosts prices sent to Tesla to trigger exports during peak periods.</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>Price Offset:</strong> Adds this amount to all export prices (e.g., +5c makes 20c appear as 25c to Tesla)</li>
                            <li style="margin: 0.5em 0;"><strong>Minimum Price:</strong> Sets a floor price (e.g., 20c minimum ensures prices never appear lower)</li>
                            <li style="margin: 0.5em 0;"><strong>Activation Threshold:</strong> Boost only applies if actual price is at or above this value (e.g., 10c threshold skips boost for very low/negative prices)</li>
                            <li style="margin: 0.5em 0;"><strong>Time Window:</strong> Only applies boost during these hours (typically peak export times)</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>Chip Mode</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Prevent Powerwall from exporting during configured hours unless the price exceeds your threshold. Useful for overnight stability while still capturing price spikes.
                </p>

                <label for="chip_mode_enabled" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="chip_mode_enabled" name="chip_mode_enabled"
                           {% if current_user.chip_mode_enabled %}checked{% endif %}
                           onchange="toggleChipModeDetails()">
                    <span>Enable Chip Mode</span>
                </label>

                <div id="chipModeDetails" style="margin-top: 1em; {% if not current_user.chip_mode_enabled %}display: none;{% endif %}">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                        <label for="chip_mode_start">
                            Start Time
                            <small>When to start suppressing exports</small>
                            <input type="time" id="chip_mode_start" name="chip_mode_start"
                                   value="{{ current_user.chip_mode_start or '22:00' }}"
                                   style="width: 100%;">
                        </label>

                        <label for="chip_mode_end">
                            End Time
                            <small>When to stop suppressing exports</small>
                            <input type="time" id="chip_mode_end" name="chip_mode_end"
                                   value="{{ current_user.chip_mode_end or '06:00' }}"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <div style="margin-top: 1em;">
                        <label for="chip_mode_threshold">
                            Price Threshold (c/kWh)
                            <small>Allow exports only when price is at or above this value</small>
                            <input type="number" id="chip_mode_threshold" name="chip_mode_threshold"
                                   value="{{ current_user.chip_mode_threshold or 30 }}"
                                   step="1" min="0" max="200"
                                   style="width: 100%;">
                        </label>
                    </div>

                    <p style="font-size: 0.75em; margin: 1em 0 0 0; color: var(--muted-color);">
                        Example: With threshold=30c between 22:00-06:00: if export price is 8c, Tesla sees 0c (no export). If export price spikes to 35c, Tesla sees 35c (allows export).
                    </p>
                </div>
                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">When should I use this?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.05); border-radius: 0.3em;">
                        <p style="margin: 0.3em 0;">Chip Mode is the inverse of Export Boost. Use it to keep your battery stable overnight while still capturing unexpected price spikes.</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>Time Window:</strong> Typically overnight (22:00-06:00) when you want the battery to stay charged</li>
                            <li style="margin: 0.5em 0;"><strong>Price Threshold:</strong> Set above normal overnight prices (e.g., 30c). Exports blocked below this, allowed above</li>
                            <li style="margin: 0.5em 0;"><strong>Spike Capture:</strong> If a sudden price spike exceeds your threshold, Powerwall can still export to capitalise</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <fieldset>
                <legend>üß™ Alpha Options</legend>
                <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                    Experimental features that may improve Powerwall responsiveness.
                </p>

                <label for="force_tariff_mode_toggle" style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                    <input type="checkbox" id="force_tariff_mode_toggle" name="force_tariff_mode_toggle"
                           {% if current_user.force_tariff_mode_toggle %}checked{% endif %}>
                    <span>Force mode toggle after tariff sync</span>
                </label>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em;">How does this work?</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(255, 193, 7, 0.1); border-radius: 0.3em; border-left: 3px solid #ffc107;">
                        <p style="margin: 0.3em 0;">After uploading a new tariff, this briefly switches the Powerwall to self-consumption mode then back to Time-Based Control.</p>
                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                            <li style="margin: 0.5em 0;"><strong>Why:</strong> Forces the Powerwall to immediately recalculate its behavior based on the new tariff prices.</li>
                            <li style="margin: 0.5em 0;"><strong>Without this:</strong> The Powerwall may take several minutes to recognize tariff changes.</li>
                            <li style="margin: 0.5em 0;"><strong>Trade-off:</strong> May cause brief interruption (~5 seconds) to battery behavior during mode switch.</li>
                        </ul>
                    </div>
                </details>
            </fieldset>

            <div style="margin-top: 1.5em;">
                {{ form.submit(style="width: 100%;") }}
            </div>
        </form>
    </article>

    <!-- Information Box -->
    <article style="margin-top: 1.5em; background: rgba(100, 150, 200, 0.05); border-left: 4px solid var(--primary);">
        <header><strong>‚ÑπÔ∏è About These Settings</strong></header>
        <p style="font-size: 0.9em; margin: 0;">These settings only affect the TOU tariff that gets synced to your Tesla Powerwall. Changes will take effect on the next automatic sync (every 5 minutes).</p>
        <p style="font-size: 0.9em; margin: 0.5em 0 0 0;">You can test different forecast types to see which strategy works best for your usage patterns and preferences.</p>
    </article>

    <script>
        function toggleExportBoostDetails() {
            const enabled = document.getElementById('export_boost_enabled').checked;
            const details = document.getElementById('exportBoostDetails');
            if (details) {
                details.style.display = enabled ? 'block' : 'none';
            }
        }

        function toggleChipModeDetails() {
            const enabled = document.getElementById('chip_mode_enabled').checked;
            const details = document.getElementById('chipModeDetails');
            if (details) {
                details.style.display = enabled ? 'block' : 'none';
            }
        }

        function toggleInverterDetails() {
            const enabled = document.getElementById('inverter_curtailment_enabled').checked;
            const details = document.getElementById('inverterDetails');
            if (details) {
                details.style.display = enabled ? 'block' : 'none';
            }
        }

        function toggleSigenergyModbusConfig() {
            const enabled = document.getElementById('solar_curtailment_enabled').checked;
            const config = document.getElementById('sigenergyModbusConfig');
            if (config) {
                config.style.display = enabled ? 'block' : 'none';
            }
        }

        // Inverter models by brand
        const inverterModels = {
            sungrow: {
                "sg2.5rs": "SG2.5RS", "sg3.0rs": "SG3.0RS", "sg3.6rs": "SG3.6RS",
                "sg4.0rs": "SG4.0RS", "sg5.0rs": "SG5.0RS", "sg6.0rs": "SG6.0RS",
                "sg7.0rs": "SG7.0RS", "sg8.0rs": "SG8.0RS", "sg10rs": "SG10RS",
                "sg12rs": "SG12RS", "sg15rs": "SG15RS", "sg17rs": "SG17RS", "sg20rs": "SG20RS",
                "sh3.0rs": "SH3.0RS", "sh3.6rs": "SH3.6RS", "sh4.0rs": "SH4.0RS",
                "sh4.6rs": "SH4.6RS", "sh5.0rs": "SH5.0RS", "sh6.0rs": "SH6.0RS",
                "sh5.0rt": "SH5.0RT", "sh6.0rt": "SH6.0RT", "sh8.0rt": "SH8.0RT",
                "sh10rt": "SH10RT", "sh15t": "SH15T", "sh20t": "SH20T", "sh25t": "SH25T"
            },
            fronius: {
                "primo": "Primo (Single Phase)", "symo": "Symo (Three Phase)",
                "gen24": "Gen24 / Tauro", "eco": "Eco"
            },
            goodwe: {
                "et": "ET Series (Hybrid)", "eh": "EH Series (Hybrid)",
                "bt": "BT Series (Hybrid)", "bh": "BH Series (Hybrid)",
                "es": "ES Series (Hybrid)", "em": "EM Series (Hybrid)"
            },
            huawei: {
                "sun2000-2ktl-l1": "SUN2000-2KTL-L1", "sun2000-3ktl-l1": "SUN2000-3KTL-L1",
                "sun2000-4ktl-l1": "SUN2000-4KTL-L1", "sun2000-5ktl-l1": "SUN2000-5KTL-L1",
                "sun2000-6ktl-l1": "SUN2000-6KTL-L1",
                "sun2000-3ktl-m1": "SUN2000-3KTL-M1", "sun2000-5ktl-m1": "SUN2000-5KTL-M1",
                "sun2000-6ktl-m1": "SUN2000-6KTL-M1", "sun2000-8ktl-m1": "SUN2000-8KTL-M1",
                "sun2000-10ktl-m1": "SUN2000-10KTL-M1",
                "sun2000-8ktl-m2": "SUN2000-8KTL-M2", "sun2000-10ktl-m2": "SUN2000-10KTL-M2",
                "sun2000-12ktl-m2": "SUN2000-12KTL-M2", "sun2000-15ktl-m2": "SUN2000-15KTL-M2",
                "sun2000-17ktl-m2": "SUN2000-17KTL-M2", "sun2000-20ktl-m2": "SUN2000-20KTL-M2"
            },
            enphase: {
                "envoy": "Envoy (Legacy)", "envoy-s": "Envoy-S",
                "envoy-s-metered": "Envoy-S Metered",
                "iq-gateway": "IQ Gateway", "iq-gateway-metered": "IQ Gateway Metered"
            },
            zeversolar: {
                "tlc5000": "TLC5000", "tlc6000": "TLC6000",
                "zevershine-5000tl": "Zevershine 5000TL", "zevershine-6000tl": "Zevershine 6000TL",
                "evershine-tlc5000": "Evershine TLC5000", "evershine-tlc6000": "Evershine TLC6000",
                "other": "Other Zeversolar"
            }
        };

        // Brand-specific defaults
        const brandDefaults = {
            sungrow: { port: 502, slaveId: 1, protocol: 'Modbus TCP' },
            fronius: { port: 502, slaveId: 1, protocol: 'Modbus TCP (SunSpec)' },
            goodwe: { port: 502, slaveId: 247, protocol: 'Modbus TCP' },
            huawei: { port: 502, slaveId: 1, protocol: 'Modbus TCP' },
            enphase: { port: 443, slaveId: 1, protocol: 'HTTPS REST API' },
            zeversolar: { port: 80, slaveId: 1, protocol: 'HTTP API' }
        };

        function updateInverterModels() {
            const brand = document.getElementById('inverter_brand').value;
            const modelSelect = document.getElementById('inverter_model');
            const portInput = document.getElementById('inverter_port');
            const slaveIdInput = document.getElementById('inverter_slave_id');
            const slaveIdLabel = document.getElementById('slaveIdLabel');
            const currentModel = '{{ current_user.inverter_model or "" }}';

            // Clear existing options
            modelSelect.innerHTML = '<option value="">Select model...</option>';

            if (brand && inverterModels[brand]) {
                // Add models for selected brand
                for (const [value, label] of Object.entries(inverterModels[brand])) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    if (value === currentModel) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                }

                // Update defaults
                const defaults = brandDefaults[brand];
                if (defaults) {
                    portInput.value = defaults.port;
                    slaveIdInput.value = defaults.slaveId;
                }

                // Show/hide Slave ID for Enphase (doesn't use Modbus)
                if (slaveIdLabel) {
                    slaveIdLabel.style.display = (brand === 'enphase') ? 'none' : 'block';
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const brandSelect = document.getElementById('inverter_brand');
            if (brandSelect) {
                brandSelect.addEventListener('change', updateInverterModels);
                // Initialize models if brand is already selected
                if (brandSelect.value) {
                    updateInverterModels();
                }
            }
        });

        async function testInverterConnection() {
            const btn = document.getElementById('testInverterBtn');
            const result = document.getElementById('inverterTestResult');
            const host = document.getElementById('inverter_host').value;
            const port = document.getElementById('inverter_port').value;
            const slaveId = document.getElementById('inverter_slave_id').value;
            const brand = document.getElementById('inverter_brand').value;

            if (!host || !brand) {
                result.innerHTML = '<span style="color: #ff6b6b;">Please enter IP address and select brand</span>';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Testing...';
            result.innerHTML = '';

            try {
                const response = await fetch('/api/inverter/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        brand: brand,
                        host: host,
                        port: parseInt(port) || 502,
                        slave_id: parseInt(slaveId) || 1
                    })
                });

                const data = await response.json();
                if (data.success) {
                    result.innerHTML = '<span style="color: #51cf66;">' + data.message + '</span>';
                } else {
                    result.innerHTML = '<span style="color: #ff6b6b;">' + (data.error || 'Connection failed') + '</span>';
                }
            } catch (error) {
                result.innerHTML = '<span style="color: #ff6b6b;">Error: ' + error.message + '</span>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Test Connection';
            }
        }

        async function curtailInverter() {
            const btn = document.getElementById('curtailInverterBtn');
            const result = document.getElementById('inverterTestResult');

            btn.disabled = true;
            btn.innerHTML = 'Curtailing...';
            result.innerHTML = '';

            try {
                const response = await fetch('/api/inverter/curtail', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                if (data.success) {
                    result.innerHTML = '<span style="color: #51cf66;">Inverter curtailed successfully</span>';
                } else {
                    result.innerHTML = '<span style="color: #ff6b6b;">' + (data.error || 'Curtail failed') + '</span>';
                }
            } catch (error) {
                result.innerHTML = '<span style="color: #ff6b6b;">Error: ' + error.message + '</span>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üî¥ Curtail';
            }
        }

        async function restoreInverter() {
            const btn = document.getElementById('restoreInverterBtn');
            const result = document.getElementById('inverterTestResult');

            btn.disabled = true;
            btn.innerHTML = 'Restoring...';
            result.innerHTML = '';

            try {
                const response = await fetch('/api/inverter/restore', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                if (data.success) {
                    result.innerHTML = '<span style="color: #51cf66;">Inverter restored successfully</span>';
                } else {
                    result.innerHTML = '<span style="color: #ff6b6b;">' + (data.error || 'Restore failed') + '</span>';
                }
            } catch (error) {
                result.innerHTML = '<span style="color: #ff6b6b;">Error: ' + error.message + '</span>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üü¢ Restore';
            }
        }
    </script>
{% endblock %}
