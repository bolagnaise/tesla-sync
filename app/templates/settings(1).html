{% extends "settings_base.html" %}

{% block settings_content %}
    <hgroup>
        <h1>Configuration</h1>
        <h2>Configure your API credentials and preferences</h2>
    </hgroup>

    <!-- Electricity Provider - Contains all provider-specific settings -->
    <article>
        <header><strong>Electricity Provider</strong></header>
        <p>Select your electricity provider and configure its settings.</p>

        <form action="{{ url_for('main.settings') }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            <label for="electricity_provider">
                Provider
                <select id="electricity_provider" name="electricity_provider" onchange="toggleProviderSettings()">
                    <option value="amber" {% if not current_user.electricity_provider or current_user.electricity_provider == 'amber' %}selected{% endif %}>Amber Electric</option>
                    <option value="flow_power" {% if current_user.electricity_provider == 'flow_power' %}selected{% endif %}>Flow Power</option>
                    <option value="globird" {% if current_user.electricity_provider == 'globird' %}selected{% endif %}>Globird</option>
                </select>
            </label>

            <!-- Amber Electric Settings -->
            <div id="amberSettings" style="margin-top: 1em; {% if current_user.electricity_provider not in [None, '', 'amber'] %}display: none;{% endif %}">
                <fieldset>
                    <legend>Amber Electric Settings</legend>
                    <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                        Amber provides real-time wholesale electricity prices. Your Tesla will automatically adjust based on current prices.
                    </p>

                    <label for="amber_token">
                        {{ form.amber_token.label }}
                        <small>Get this from your <a href="https://app.amber.com.au/developers" target="_blank">Amber developer settings</a>.</small>
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        {{ form.amber_token(size=64, type='password', class='secure-field', style='width: 100%;') }}
                        <button type="button" onclick="toggleVisibility('amber_token', this)"
                                style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                       font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                                aria-label="Toggle visibility" title="Show/Hide API Token">
                            üëÅÔ∏è
                        </button>
                    </div>
                </fieldset>
            </div>

            <!-- Flow Power Settings -->
            <div id="flowPowerSettings" style="margin-top: 1em; {% if current_user.electricity_provider != 'flow_power' %}display: none;{% endif %}">
                <fieldset>
                    <legend>Flow Power Settings</legend>
                    <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                        Configure your Flow Power wholesale electricity plan with Happy Hour export rates.
                    </p>

                    <label for="flow_power_state">
                        State / NEM Region
                        <small>Determines your Happy Hour export rate</small>
                        <select id="flow_power_state" name="flow_power_state">
                            <option value="NSW1" {% if current_user.flow_power_state == 'NSW1' %}selected{% endif %}>New South Wales (45c export)</option>
                            <option value="VIC1" {% if current_user.flow_power_state == 'VIC1' %}selected{% endif %}>Victoria (35c export)</option>
                            <option value="QLD1" {% if current_user.flow_power_state == 'QLD1' %}selected{% endif %}>Queensland (45c export)</option>
                            <option value="SA1" {% if current_user.flow_power_state == 'SA1' %}selected{% endif %}>South Australia (45c export)</option>
                        </select>
                    </label>

                    <label for="flow_power_price_source" style="margin-top: 0.5em;">
                        Import Price Source
                        <small>Where to get wholesale electricity prices</small>
                        <select id="flow_power_price_source" name="flow_power_price_source" onchange="toggleFlowPowerAmberToken()">
                            <option value="amber" {% if not current_user.flow_power_price_source or current_user.flow_power_price_source == 'amber' %}selected{% endif %}>Amber API</option>
                            <option value="aemo" {% if current_user.flow_power_price_source == 'aemo' %}selected{% endif %}>AEMO Wholesale (no API key needed)</option>
                        </select>
                    </label>

                    <!-- Amber token for Flow Power (shown when using Amber as price source) -->
                    <div id="flowPowerAmberToken" style="margin-top: 1em; {% if current_user.flow_power_price_source == 'aemo' %}display: none;{% endif %}">
                        <label for="amber_token_fp">
                            Amber API Token
                            <small>Required when using Amber API as price source. Get from <a href="https://app.amber.com.au/developers" target="_blank">Amber developer settings</a>.</small>
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.5em;">
                            {{ form.amber_token(size=64, type='password', class='secure-field', style='width: 100%;', id='amber_token_fp') }}
                            <button type="button" onclick="toggleVisibility('amber_token_fp', this)"
                                    style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                           font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                                    aria-label="Toggle visibility" title="Show/Hide API Token">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </div>

                    <!-- Network Tariff Configuration (shown when using AEMO as price source) -->
                    <div id="networkTariffConfig" style="margin-top: 1em; {% if current_user.flow_power_price_source != 'aemo' %}display: none;{% endif %}">
                        <fieldset style="border: 1px solid var(--muted-border-color); padding: 1em; border-radius: 0.5em;">
                            <legend style="font-weight: bold;">Network Tariff (DNSP Charges)</legend>
                            <p style="font-size: 0.8em; margin: 0 0 1em 0; color: var(--muted-color);">
                                AEMO provides wholesale prices only. Select your distributor and tariff code to automatically apply network charges.
                            </p>

                            <!-- Distributor Selection -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                                <label for="network_distributor">
                                    Network Distributor (DNSP)
                                    <select id="network_distributor" name="network_distributor" onchange="updateTariffCodes()">
                                        <option value="energex" {% if current_user.network_distributor == 'energex' %}selected{% endif %}>Energex (QLD SE)</option>
                                        <option value="ergon" {% if current_user.network_distributor == 'ergon' %}selected{% endif %}>Ergon Energy (QLD Regional)</option>
                                        <option value="ausgrid" {% if current_user.network_distributor == 'ausgrid' %}selected{% endif %}>Ausgrid (NSW)</option>
                                        <option value="endeavour" {% if current_user.network_distributor == 'endeavour' %}selected{% endif %}>Endeavour Energy (NSW)</option>
                                        <option value="essential" {% if current_user.network_distributor == 'essential' %}selected{% endif %}>Essential Energy (NSW Regional)</option>
                                        <option value="sapower" {% if current_user.network_distributor == 'sapower' %}selected{% endif %}>SA Power Networks (SA)</option>
                                        <option value="powercor" {% if current_user.network_distributor == 'powercor' %}selected{% endif %}>Powercor (VIC West)</option>
                                        <option value="citipower" {% if current_user.network_distributor == 'citipower' %}selected{% endif %}>CitiPower (VIC Melbourne)</option>
                                        <option value="ausnet" {% if current_user.network_distributor == 'ausnet' %}selected{% endif %}>AusNet Services (VIC East)</option>
                                        <option value="jemena" {% if current_user.network_distributor == 'jemena' %}selected{% endif %}>Jemena (VIC North)</option>
                                        <option value="united" {% if current_user.network_distributor == 'united' %}selected{% endif %}>United Energy (VIC South)</option>
                                        <option value="tasnetworks" {% if current_user.network_distributor == 'tasnetworks' %}selected{% endif %}>TasNetworks (TAS)</option>
                                        <option value="evoenergy" {% if current_user.network_distributor == 'evoenergy' %}selected{% endif %}>Evoenergy (ACT)</option>
                                    </select>
                                </label>

                                <label for="network_tariff_code">
                                    Tariff Code
                                    <select id="network_tariff_code" name="network_tariff_code">
                                        <!-- Options populated by JavaScript based on distributor -->
                                    </select>
                                    <small style="font-size: 0.75em; color: var(--muted-color);">Select your tariff from your electricity bill</small>
                                </label>
                            </div>

                            <!-- Manual Override Checkbox -->
                            <div style="margin-top: 1em; padding: 0.75em; background: var(--card-sectionning-background-color); border-radius: 0.5em;">
                                <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer; margin: 0;">
                                    <input type="checkbox" id="network_use_manual_rates" name="network_use_manual_rates"
                                           {% if current_user.network_use_manual_rates %}checked{% endif %}
                                           onchange="toggleManualRates()" style="width: auto;">
                                    <span>Use manual rate entry instead of automatic tariff lookup</span>
                                </label>
                                <p style="font-size: 0.75em; color: var(--muted-color); margin: 0.5em 0 0 1.5em;">
                                    Enable if your tariff isn't supported or you want to enter custom rates
                                </p>
                            </div>

                            <!-- Manual Rate Entry Section (hidden by default) -->
                            <div id="manualRatesSection" style="margin-top: 1em; {% if not current_user.network_use_manual_rates %}display: none;{% endif %}">
                                <p style="font-size: 0.75em; margin: 0 0 1em 0; padding: 0.5em; background: rgba(59, 130, 246, 0.1); border-radius: 4px; color: var(--primary);">
                                    <strong>‚ö†Ô∏è Enter rates in cents/kWh:</strong> If your tariff shows $0.19367/kWh, enter <strong>19.367</strong>
                                </p>

                                <label for="network_tariff_type">
                                    Tariff Type
                                    <select id="network_tariff_type" name="network_tariff_type" onchange="toggleNetworkTariffType()">
                                        <option value="flat" {% if current_user.network_tariff_type == 'flat' %}selected{% endif %}>Flat Rate (single rate all day)</option>
                                        <option value="tou" {% if current_user.network_tariff_type == 'tou' %}selected{% endif %}>Time of Use (peak/shoulder/off-peak)</option>
                                    </select>
                                </label>

                            <!-- Flat Rate Configuration -->
                            <div id="networkFlatRateConfig" style="margin-top: 1em; {% if current_user.network_tariff_type == 'tou' %}display: none;{% endif %}">
                                <label for="network_flat_rate">
                                    Network Rate (c/kWh)
                                    <small>Your DNSP flat rate charge</small>
                                    <input type="number" id="network_flat_rate" name="network_flat_rate"
                                           value="{{ current_user.network_flat_rate or 8.0 }}" step="0.01" min="0"
                                           style="max-width: 150px;">
                                </label>
                            </div>

                            <!-- Time of Use Configuration -->
                            <div id="networkTOUConfig" style="margin-top: 1em; {% if current_user.network_tariff_type != 'tou' %}display: none;{% endif %}">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1em;">
                                    <div>
                                        <label for="network_peak_rate" style="font-size: 0.9em;">
                                            Peak (c/kWh)
                                            <input type="number" id="network_peak_rate" name="network_peak_rate"
                                                   value="{{ current_user.network_peak_rate or 15.0 }}" step="0.01" min="0">
                                        </label>
                                    </div>
                                    <div>
                                        <label for="network_shoulder_rate" style="font-size: 0.9em;">
                                            Shoulder (c/kWh)
                                            <input type="number" id="network_shoulder_rate" name="network_shoulder_rate"
                                                   value="{{ current_user.network_shoulder_rate or 5.0 }}" step="0.01" min="0">
                                        </label>
                                    </div>
                                    <div>
                                        <label for="network_offpeak_rate" style="font-size: 0.9em;">
                                            Off-Peak (c/kWh)
                                            <input type="number" id="network_offpeak_rate" name="network_offpeak_rate"
                                                   value="{{ current_user.network_offpeak_rate or 2.0 }}" step="0.01" min="0">
                                        </label>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-top: 1em;">
                                    <div>
                                        <label style="font-size: 0.9em;">
                                            Peak Period
                                            <div style="display: flex; gap: 0.5em; align-items: center;">
                                                <select id="network_peak_start" name="network_peak_start" style="width: 80px;">
                                                    {% for h in range(24) %}
                                                    <option value="{{ '%02d:00'|format(h) }}" {% if (current_user.network_peak_start or '16:00')[:2]|int == h %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                                                    {% endfor %}
                                                </select>
                                                <span>to</span>
                                                <select id="network_peak_end" name="network_peak_end" style="width: 80px;">
                                                    {% for h in range(24) %}
                                                    <option value="{{ '%02d:00'|format(h) }}" {% if (current_user.network_peak_end or '21:00')[:2]|int == h %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </label>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.9em;">
                                            Off-Peak Period
                                            <div style="display: flex; gap: 0.5em; align-items: center;">
                                                <select id="network_offpeak_start" name="network_offpeak_start" style="width: 80px;">
                                                    {% for h in range(24) %}
                                                    <option value="{{ '%02d:00'|format(h) }}" {% if (current_user.network_offpeak_start or '10:00')[:2]|int == h %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                                                    {% endfor %}
                                                </select>
                                                <span>to</span>
                                                <select id="network_offpeak_end" name="network_offpeak_end" style="width: 80px;">
                                                    {% for h in range(24) %}
                                                    <option value="{{ '%02d:00'|format(h) }}" {% if (current_user.network_offpeak_end or '15:00')[:2]|int == h %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <p style="font-size: 0.75em; color: var(--muted-color); margin-top: 0.5em;">
                                    Shoulder rate applies to all other times not covered by peak or off-peak periods.
                                </p>
                            </div>

                            <!-- Other Fees and GST (only for manual rates) -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-top: 1em; padding-top: 1em; border-top: 1px solid var(--muted-border-color);">
                                <div>
                                    <label for="network_other_fees" style="font-size: 0.9em;">
                                        Other Fees (c/kWh)
                                        <small>Environmental, market fees</small>
                                        <input type="number" id="network_other_fees" name="network_other_fees"
                                               value="{{ current_user.network_other_fees or 1.5 }}" step="0.1" min="0"
                                               style="max-width: 100px;">
                                    </label>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <label style="font-size: 0.9em;">
                                        <input type="checkbox" id="network_include_gst" name="network_include_gst"
                                               {% if current_user.network_include_gst is not defined or current_user.network_include_gst %}checked{% endif %}>
                                        Include GST (10%)
                                    </label>
                                </div>
                            </div>
                            </div><!-- End manualRatesSection -->
                        </fieldset>
                    </div>

                    <!-- Flow Power PEA (Price Efficiency Adjustment) Settings -->
                    <div id="peaSettings" style="margin-top: 1em;">
                        <fieldset style="border: 1px solid var(--primary); padding: 1em; border-radius: 0.5em; background: rgba(59, 130, 246, 0.05);">
                            <legend style="font-weight: bold; color: var(--primary);">‚ö° Flow Power PEA Pricing</legend>
                            <p style="font-size: 0.8em; margin: 0 0 1em 0; color: var(--muted-color);">
                                PEA (Price Efficiency Adjustment) uses Flow Power's actual billing model. When enabled, your rate is:<br>
                                <strong>Final Rate = Base Rate + (Wholesale ‚àí 9.7c)</strong>
                            </p>

                            <!-- PEA Enabled Toggle -->
                            <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer; margin: 0 0 1em 0;">
                                <input type="checkbox" id="pea_enabled" name="pea_enabled"
                                       {% if current_user.pea_enabled is not defined or current_user.pea_enabled %}checked{% endif %}
                                       onchange="togglePeaSettings()" style="width: auto;">
                                <span>Enable PEA Pricing (Recommended)</span>
                            </label>

                            <div id="peaSettingsDetail" style="{% if current_user.pea_enabled is defined and not current_user.pea_enabled %}display: none;{% endif %}">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
                                    <label for="flow_power_base_rate">
                                        Base Rate (c/kWh)
                                        <small>Your Flow Power advertised rate (check your plan)</small>
                                        <input type="number" id="flow_power_base_rate" name="flow_power_base_rate"
                                               value="{{ current_user.flow_power_base_rate or 34.0 }}" step="0.1" min="0"
                                               style="max-width: 150px;">
                                    </label>

                                    <label for="pea_custom_value">
                                        Custom PEA Override (c/kWh)
                                        <small>Optional: enter your historical PEA from bills</small>
                                        <input type="number" id="pea_custom_value" name="pea_custom_value"
                                               value="{{ current_user.pea_custom_value or '' }}" step="0.1"
                                               placeholder="Leave blank for auto"
                                               style="max-width: 150px;">
                                    </label>
                                </div>

                                <details style="margin-top: 1em;">
                                    <summary style="font-size: 0.85em; cursor: pointer;">How does PEA work?</summary>
                                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 150, 200, 0.1); border-radius: 0.3em;">
                                        <p style="margin: 0.3em 0;">PEA adjusts your rate based on wholesale prices:</p>
                                        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                                            <li style="margin: 0.3em 0;"><strong>Cheap wholesale (-0.5c):</strong> 34 + (-0.5 ‚àí 9.7) = <span style="color: #22c55e;">23.8c/kWh</span></li>
                                            <li style="margin: 0.3em 0;"><strong>Average wholesale (8c):</strong> 34 + (8 ‚àí 9.7) = 32.3c/kWh</li>
                                            <li style="margin: 0.3em 0;"><strong>Expensive wholesale (15c):</strong> 34 + (15 ‚àí 9.7) = <span style="color: #ef4444;">39.3c/kWh</span></li>
                                        </ul>
                                        <p style="margin: 0.5em 0 0 0;">Import during cheap periods to save money!</p>
                                    </div>
                                </details>
                            </div>

                            <p id="peaDisabledNote" style="font-size: 0.8em; margin: 1em 0 0 0; color: var(--muted-color); {% if current_user.pea_enabled is not defined or current_user.pea_enabled %}display: none;{% endif %}">
                                ‚ö†Ô∏è PEA disabled - using network tariff settings above instead.
                            </p>
                        </fieldset>
                    </div>

                    <article style="background: rgba(100, 200, 150, 0.15); padding: 0.8em; border-radius: 0.5em; margin-top: 1em; border-left: 4px solid #51cf66;">
                        <p style="margin: 0; font-size: 0.85em;">
                            <strong>Flow Power Happy Hour:</strong> 5:30pm - 7:30pm daily<br>
                            <strong>Export rate during Happy Hour:</strong>
                            {% if current_user.flow_power_state == 'VIC1' %}35c/kWh{% else %}45c/kWh{% endif %}<br>
                            <strong>Export rate outside Happy Hour:</strong> 0c/kWh
                        </p>
                    </article>
                </fieldset>
            </div>

            <!-- Globird Settings (AEMO Spike Detection) -->
            <div id="globirdSettings" style="margin-top: 1em; {% if current_user.electricity_provider != 'globird' %}display: none;{% endif %}">
                <fieldset>
                    <legend>Globird - AEMO Spike Detection</legend>
                    <p style="font-size: 0.85em; margin: 0 0 1em 0; color: var(--muted-color);">
                        Monitor AEMO wholesale prices and automatically export during price spikes.
                    </p>

                    {% if current_user.sync_enabled %}
                    <article style="background: rgba(255, 165, 0, 0.15); padding: 1em; border-radius: 0.5em; margin-bottom: 1em; border-left: 4px solid orange;">
                        <p style="margin: 0; font-size: 0.85em;">
                            ‚ö†Ô∏è <strong>Note:</strong> AEMO spike detection is automatically disabled when Amber auto sync is enabled.
                        </p>
                    </article>
                    {% endif %}

                    <label for="aemo_spike_detection_enabled">
                        <input type="checkbox" id="aemo_spike_detection_enabled" name="aemo_spike_detection_enabled"
                               {% if form.aemo_spike_detection_enabled.data %}checked{% endif %}
                               onchange="toggleGlobirdAemoFields(this.checked)">
                        Enable AEMO Spike Detection
                    </label>

                    <div id="globird-aemo-fields" style="{% if not form.aemo_spike_detection_enabled.data %}display: none;{% endif %} margin-top: 1em;">
                        <label for="aemo_region">
                            {{ form.aemo_region.label }}
                            <small>Select your NEM region</small>
                            <select id="aemo_region" name="aemo_region">
                                <option value="">Select Region...</option>
                                <option value="NSW1" {% if form.aemo_region.data == 'NSW1' %}selected{% endif %}>NSW - New South Wales</option>
                                <option value="QLD1" {% if form.aemo_region.data == 'QLD1' %}selected{% endif %}>QLD - Queensland</option>
                                <option value="VIC1" {% if form.aemo_region.data == 'VIC1' %}selected{% endif %}>VIC - Victoria</option>
                                <option value="SA1" {% if form.aemo_region.data == 'SA1' %}selected{% endif %}>SA - South Australia</option>
                                <option value="TAS1" {% if form.aemo_region.data == 'TAS1' %}selected{% endif %}>TAS - Tasmania</option>
                            </select>
                        </label>

                        <label for="aemo_spike_threshold" style="margin-top: 0.5em;">
                            {{ form.aemo_spike_threshold.label }}
                            <small>{{ form.aemo_spike_threshold.description }}</small>
                            <input type="number" id="aemo_spike_threshold" name="aemo_spike_threshold"
                                   value="{{ form.aemo_spike_threshold.data or 300 }}" step="0.01" min="0"
                                   placeholder="300.00" style="max-width: 200px;">
                        </label>

                        {% if current_user.aemo_spike_detection_enabled %}
                        <article style="background: rgba(100, 200, 150, 0.1); padding: 1em; border-radius: 0.5em; margin-top: 1em;">
                            <p style="margin: 0; font-size: 0.85em;"><strong>Status:</strong></p>
                            <ul style="margin: 0.5em 0 0 1.5em; padding: 0; font-size: 0.85em;">
                                <li>Region: <strong>{{ current_user.aemo_region or 'Not set' }}</strong></li>
                                <li>Threshold: <strong>${{ '%.2f'|format(current_user.aemo_spike_threshold or 0) }}/MWh</strong></li>
                                {% if current_user.aemo_last_price %}
                                <li>Last Price: <strong>${{ '%.2f'|format(current_user.aemo_last_price) }}/MWh</strong>
                                    {% if current_user.aemo_in_spike_mode %}
                                        <span style="color: #dc3545;">‚ö†Ô∏è IN SPIKE MODE</span>
                                    {% else %}
                                        <span style="color: #28a745;">‚úì Normal</span>
                                    {% endif %}
                                </li>
                                {% endif %}
                            </ul>
                        </article>
                        {% endif %}

                        <details style="margin-top: 1em;">
                            <summary style="font-size: 0.85em;">How It Works</summary>
                            <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 150, 0.05); border-radius: 0.3em;">
                                <ol style="margin: 0 0 0 1.2em; padding: 0;">
                                    <li>Checks AEMO prices every 5 minutes</li>
                                    <li>When price ‚â• threshold: Backs up tariff & uploads spike tariff</li>
                                    <li>When price < threshold: Restores original tariff</li>
                                </ol>
                            </div>
                        </details>
                    </div>
                </fieldset>
            </div>

            <button type="submit" class="primary" style="margin-top: 1em;">Save Provider Settings</button>
        </form>
    </article>

    <!-- Tesla Configuration - Combined Section -->
    <article>
        <header><strong>Tesla Configuration</strong></header>
        <p>Configure your Tesla API connection and energy site.</p>

        <form action="{{ url_for('main.settings') }}" method="post" novalidate>
            {{ form.hidden_tag() }}

            <!-- Tesla API Provider Selection -->
            <label for="tesla_api_provider">
                API Provider
                <small>Choose how to connect to your Tesla Powerwall</small>
                <select id="tesla_api_provider" name="tesla_api_provider" onchange="toggleTeslaProviderSettings(); this.form.submit();">
                    <option value="teslemetry" {% if not current_user.tesla_api_provider or current_user.tesla_api_provider == 'teslemetry' %}selected{% endif %}>Teslemetry (~$4/month, easy setup)</option>
                    <option value="fleet_api" {% if current_user.tesla_api_provider == 'fleet_api' %}selected{% endif %}>Tesla Fleet API (free, requires setup)</option>
                </select>
            </label>

            <!-- Teslemetry Settings (shown when Teslemetry is selected) -->
            <div id="teslemetrySettings" style="margin-top: 1em; {% if current_user.tesla_api_provider == 'fleet_api' %}display: none;{% endif %}">
                <fieldset>
                    <legend>Teslemetry API</legend>

                    {% if current_user.teslemetry_api_key_encrypted %}
                    <div style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin-bottom: 1em;">
                        <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Connected</strong></p>
                    </div>
                    {% endif %}

                    <label for="teslemetry_api_key">
                        {{ form.teslemetry_api_key.label }}
                        <small>Get from <a href="https://teslemetry.com" target="_blank">teslemetry.com</a> after connecting your Tesla account.</small>
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        {{ form.teslemetry_api_key(size=64, type='password', class='secure-field', style='width: 100%;') }}
                        <button type="button" onclick="toggleVisibility('teslemetry_api_key', this)"
                                style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                       font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                                aria-label="Toggle visibility" title="Show/Hide API Key">
                            üëÅÔ∏è
                        </button>
                    </div>

                    {% if current_user.teslemetry_api_key_encrypted %}
                    <form action="{{ url_for('main.teslemetry_disconnect') }}" method="post" style="margin-top: 0.5em;">
                        <button type="submit" class="outline secondary" style="font-size: 0.85em;" onclick="return confirm('Disconnect Teslemetry?')">Disconnect</button>
                    </form>
                    {% endif %}

                    <details style="margin-top: 1em;">
                        <summary style="font-size: 0.85em;">Setup Instructions</summary>
                        <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 150, 0.05); border-radius: 0.3em;">
                            <p style="margin: 0 0 0.5em 0;"><strong>‚úÖ Works with localhost (no public domain needed)</strong></p>
                            <ol style="margin: 0.3em 0 0 1.2em; padding: 0;">
                                <li style="margin: 0.3em 0;">Go to <a href="https://teslemetry.com" target="_blank">teslemetry.com</a></li>
                                <li style="margin: 0.3em 0;">Sign in with your Tesla account</li>
                                <li style="margin: 0.3em 0;">Authorize Teslemetry</li>
                                <li style="margin: 0.3em 0;">Copy your API key and paste it above</li>
                            </ol>
                        </div>
                    </details>
                </fieldset>
            </div>

            <!-- Fleet API Settings (shown when Fleet API is selected) -->
            <div id="fleetApiSettings" style="margin-top: 1em; {% if current_user.tesla_api_provider != 'fleet_api' %}display: none;{% endif %}">
                <fieldset>
                    <legend>Tesla Fleet API</legend>

                    <!-- Connection Status & Actions -->
                    {% if current_user.fleet_api_access_token_encrypted %}
                    <div style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin-bottom: 1em;">
                        <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Connected to Tesla</strong></p>
                        <p style="font-size: 0.8em; margin: 0.3em 0 0 0; color: var(--muted-color);">
                            Token auto-refreshes when needed
                        </p>
                        <div style="display: flex; gap: 0.5em; margin-top: 0.8em;">
                            <a href="{{ url_for('main.fleet_api_oauth_start') }}" class="outline" style="flex: 1; text-align: center; font-size: 0.85em;">Reconnect</a>
                            <form action="{{ url_for('main.fleet_api_disconnect') }}" method="post" style="flex: 1; margin: 0;">
                                <button type="submit" class="outline secondary" style="width: 100%; font-size: 0.85em;" onclick="return confirm('Disconnect Tesla Fleet API?')">Disconnect</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div style="padding: 0.8em; background: rgba(255, 150, 100, 0.15); border-radius: 0.5em; margin-bottom: 1em;">
                        <p style="margin: 0; color: #ff922b; font-size: 0.9em;">‚ö†Ô∏è <strong>Not Connected</strong></p>
                        <p style="font-size: 0.8em; margin: 0.3em 0 0 0; color: var(--muted-color);">
                            Complete setup below, then click "Connect to Tesla"
                        </p>
                        <a href="{{ url_for('main.fleet_api_oauth_start') }}" class="primary" style="display: block; text-align: center; width: 100%; margin-top: 0.8em;">
                            Connect to Tesla
                        </a>
                    </div>
                    {% endif %}

                    <!-- Credentials -->
                    <label for="fleet_api_client_id">
                        {{ form.fleet_api_client_id.label }}
                        <small>From <a href="https://developer.tesla.com" target="_blank">developer.tesla.com</a></small>
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        {{ form.fleet_api_client_id(size=64, type='password', class='secure-field', style='width: 100%;') }}
                        <button type="button" onclick="toggleVisibility('fleet_api_client_id', this)"
                                style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                       font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                                aria-label="Toggle visibility">üëÅÔ∏è</button>
                    </div>

                    <label for="fleet_api_client_secret" style="margin-top: 0.5em;">
                        {{ form.fleet_api_client_secret.label }}
                        <small>From <a href="https://developer.tesla.com" target="_blank">developer.tesla.com</a></small>
                    </label>
                    <div style="display: flex; align-items: center; gap: 0.5em;">
                        {{ form.fleet_api_client_secret(size=64, type='password', class='secure-field', style='width: 100%;') }}
                        <button type="button" onclick="toggleVisibility('fleet_api_client_secret', this)"
                                style="background: none; border: none; cursor: pointer; padding: 0.5em;
                                       font-size: 1.2em; color: var(--muted-color); flex-shrink: 0; width: 40px;"
                                aria-label="Toggle visibility">üëÅÔ∏è</button>
                    </div>

                    <label for="fleet_api_redirect_uri" style="margin-top: 0.5em;">
                        {{ form.fleet_api_redirect_uri.label }}
                        <small>Must match Tesla Developer Portal. Example: <code>http://localhost:5001/fleet-api/callback</code></small>
                    </label>
                    {{ form.fleet_api_redirect_uri(size=64, style='width: 100%;', placeholder='http://localhost:5001/fleet-api/callback') }}
                </fieldset>

                <!-- Fleet API Setup Tools -->
                <details style="margin-top: 1em; border: 2px solid {% if not current_user.fleet_api_access_token_encrypted %}rgba(255, 150, 100, 0.5){% else %}rgba(100, 150, 255, 0.3){% endif %}; border-radius: 0.5em; padding: 0.5em;">
                    <summary style="font-weight: bold; cursor: pointer; padding: 0.3em; {% if not current_user.fleet_api_access_token_encrypted %}color: #ff922b;{% endif %}">
                        {% if not current_user.fleet_api_access_token_encrypted %}
                        ‚öôÔ∏è First-Time Setup (click to expand)
                        {% else %}
                        ‚öôÔ∏è Setup Tools (Tunnel, Keys, Registration)
                        {% endif %}
                    </summary>
                    <div style="padding: 0.5em; margin-top: 0.5em;">
                        <p style="font-size: 0.8em; margin: 0 0 0.8em 0; color: var(--muted-color);">
                            {% if not current_user.fleet_api_access_token_encrypted %}
                            Complete these steps in order before connecting to Tesla.
                            {% else %}
                            Use these tools if you need to reconfigure your Fleet API setup.
                            {% endif %}
                        </p>

                        <!-- Step 1: Tunnel Section -->
                        <div style="padding: 0.6em; background: rgba(100, 150, 255, 0.1); border-radius: 0.5em; margin-bottom: 0.5em;">
                            <p style="margin: 0 0 0.3em 0; font-size: 0.85em;"><strong>Step 1: Start Public Tunnel</strong></p>
                            <p id="cloudflaredStatus" style="font-size: 0.8em; margin: 0 0 0.3em 0;">
                                <span style="color: #999;">Checking cloudflared...</span>
                            </p>
                            <p style="margin: 0; font-size: 0.85em;">
                                <strong>Status:</strong> <span id="tunnelStatusText">Checking...</span>
                            </p>
                            <div id="tunnelUrlDisplay" style="display: none; margin-top: 0.3em;">
                                <code id="tunnelUrl" style="font-size: 0.75em; word-break: break-all;"></code>
                            </div>
                            <div style="display: flex; gap: 0.5em; margin-top: 0.5em;">
                                <button type="button" id="startTunnelBtn" class="outline" style="flex: 1; font-size: 0.8em;" onclick="startTunnel()">Start Tunnel</button>
                                <button type="button" id="stopTunnelBtn" class="outline secondary" style="flex: 1; font-size: 0.8em; display: none;" onclick="stopTunnel()">Stop Tunnel</button>
                            </div>
                            <p id="tunnelActionStatus" style="font-size: 0.75em; margin-top: 0.3em; display: none;"></p>

                            <!-- Named Tunnel -->
                            <details style="margin-top: 0.5em;">
                                <summary style="font-size: 0.8em; color: var(--muted-color);">Advanced: Named Tunnel (stable URL)</summary>
                                <div style="padding: 0.4em; margin-top: 0.3em; background: rgba(100, 200, 100, 0.1); border-radius: 0.3em;">
                                    <input type="password" id="tunnelToken" placeholder="Tunnel Token" style="font-size: 0.8em; width: 100%; margin-bottom: 0.2em;">
                                    <input type="text" id="tunnelDomain" placeholder="tesla.mydomain.com" value="{{ current_user.cloudflare_tunnel_domain or '' }}" style="font-size: 0.8em; width: 100%; margin-bottom: 0.2em;">
                                    <label style="font-size: 0.75em; display: flex; align-items: center; gap: 0.3em;">
                                        <input type="checkbox" id="tunnelAutoStart" {% if current_user.cloudflare_tunnel_enabled %}checked{% endif %}>
                                        Auto-start on app startup
                                    </label>
                                    <div style="display: flex; gap: 0.3em; margin-top: 0.3em;">
                                        <button type="button" class="outline" style="flex: 1; font-size: 0.75em;" onclick="saveTunnelConfig()">Save</button>
                                        <button type="button" class="outline" style="flex: 1; font-size: 0.75em;" onclick="startNamedTunnel()">Start Named</button>
                                    </div>
                                    <p id="namedTunnelStatus" style="font-size: 0.75em; margin-top: 0.3em; display: none;"></p>
                                </div>
                            </details>
                        </div>

                        <!-- Step 2: Tesla Developer Portal -->
                        <div style="padding: 0.6em; background: rgba(255, 200, 100, 0.1); border-radius: 0.5em; margin-bottom: 0.5em;">
                            <p style="margin: 0 0 0.3em 0; font-size: 0.85em;"><strong>Step 2: Configure <a href="https://developer.tesla.com" target="_blank">Tesla Developer Portal</a></strong></p>
                            <p style="font-size: 0.75em; margin: 0 0 0.3em 0; color: var(--muted-color);">Copy these values to your Tesla app settings:</p>
                            <div style="font-size: 0.8em; background: rgba(0,0,0,0.2); padding: 0.4em; border-radius: 0.3em;">
                                <div style="margin-bottom: 0.2em;"><strong>Allowed Origins:</strong> <code id="allowedOriginHint">[start tunnel first]</code></div>
                                <div><strong>Redirect URI:</strong> <code id="redirectUriHint">[start tunnel first]</code></div>
                            </div>
                        </div>

                        <!-- Step 3: Keys & Registration -->
                        <div style="padding: 0.6em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em;">
                            <p style="margin: 0 0 0.3em 0; font-size: 0.85em;"><strong>Step 3: Generate Keys & Register Domain</strong></p>
                            <p style="margin: 0 0 0.3em 0; font-size: 0.8em;">
                                Keys: <span id="keyStatusText">Checking...</span>
                            </p>
                            <div style="display: flex; gap: 0.5em;">
                                <button type="button" id="generateKeysBtn" class="outline" style="flex: 1; font-size: 0.8em;" onclick="generateKeys()">Generate Keys</button>
                                <button type="button" id="registerDomainBtn" class="outline" style="flex: 1; font-size: 0.8em;" onclick="registerDomain()">Register Domain</button>
                            </div>
                            <p id="generateKeysStatus" style="font-size: 0.75em; margin-top: 0.3em; display: none;"></p>
                            <p id="registerDomainStatus" style="font-size: 0.75em; margin-top: 0.3em; display: none;"></p>
                        </div>
                    </div>
                </details>

                <details style="margin-top: 0.5em;">
                    <summary style="font-size: 0.85em; color: var(--muted-color);">Troubleshooting: 412 Precondition Failed</summary>
                    <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(255, 200, 100, 0.1); border-radius: 0.3em;">
                        <ol style="margin: 0 0 0 1.2em; padding: 0;">
                            <li>Expand "Setup Tools" above</li>
                            <li>Click "Generate Keys"</li>
                            <li>Click "Register Domain"</li>
                            <li>Try connecting again</li>
                        </ol>
                    </div>
                </details>
            </div>

            <!-- Energy Site Selection (shown for both providers) -->
            <fieldset style="margin-top: 1em;">
                <legend>Tesla Energy Site</legend>
                <div id="energy-site-container">
                    {% if current_user.tesla_energy_site_id %}
                    <div id="energy-site-status" style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                        <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Selected</strong></p>
                        <p style="margin: 0.3em 0 0 0; font-size: 0.85em;">
                            Site ID: <code id="current-site-id">{{ current_user.tesla_energy_site_id }}</code>
                        </p>
                    </div>
                    {% else %}
                    <div id="energy-site-status" style="padding: 0.8em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin: 0.5em 0;">
                        <p style="margin: 0; color: #999; font-size: 0.9em;">‚≠ï <strong>Not selected</strong></p>
                        <p style="margin: 0.3em 0 0 0; font-size: 0.75em;">Configure API credentials above first.</p>
                    </div>
                    {% endif %}

                    <div id="site-selector-container" style="display: none; margin-top: 0.5em;">
                        <label for="energy-site-select">
                            Select Energy Site
                            <select id="energy-site-select" style="width: 100%;">
                                <option value="">Loading sites...</option>
                            </select>
                        </label>
                        <button type="button" id="save-site-btn" onclick="saveSelectedSite()" class="outline" style="margin-top: 0.5em;">
                            Save Selection
                        </button>
                        <p id="site-save-status" style="font-size: 0.75em; margin-top: 0.3em; display: none;"></p>
                    </div>

                    <button type="button" onclick="loadEnergySites()" class="outline secondary" style="margin-top: 0.5em; font-size: 0.85em;">
                        üîÑ Refresh Sites
                    </button>
                </div>
            </fieldset>

            {{ form.submit(class_="primary", style="margin-top: 1em;") }}
        </form>
    </article>

    <!-- Mobile App Integration -->
    <article>
        <header><strong>Mobile App Integration</strong></header>
        <p>Connect the Tesla Sync mobile app to fetch battery health data.</p>

        <div id="battery-health-token-section">
            {% if current_user.battery_health_api_token %}
            <div style="padding: 0.8em; background: rgba(0, 255, 0, 0.1); border-radius: 0.5em; margin-bottom: 1em;">
                <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>API Token Active</strong></p>
                <p style="margin: 0.5em 0 0 0; font-size: 0.85em;">
                    Token: <code id="battery-health-token" style="font-size: 0.8em;">{{ current_user.battery_health_api_token[:8] }}...{{ current_user.battery_health_api_token[-4:] }}</code>
                    <button type="button" onclick="copyBatteryHealthToken()" style="margin-left: 0.5em; padding: 0.2em 0.5em; font-size: 0.8em;">Copy Full Token</button>
                </p>
            </div>

            <div style="display: flex; gap: 0.5em;">
                <button type="button" onclick="regenerateBatteryHealthToken()" class="outline" style="flex: 1;">
                    Regenerate Token
                </button>
                <button type="button" onclick="revokeBatteryHealthToken()" class="outline secondary" style="flex: 1;">
                    Revoke Token
                </button>
            </div>
            {% else %}
            <div style="padding: 0.8em; background: rgba(150, 150, 150, 0.1); border-radius: 0.5em; margin-bottom: 1em;">
                <p style="margin: 0; color: #999; font-size: 0.9em;">‚≠ï <strong>No API Token</strong></p>
                <p style="margin: 0.3em 0 0 0; font-size: 0.8em;">Generate a token to connect the mobile app.</p>
            </div>

            <button type="button" onclick="generateBatteryHealthToken()" class="outline primary" style="width: 100%;">
                Generate API Token
            </button>
            {% endif %}
        </div>

        <p id="battery-health-token-status" style="font-size: 0.8em; margin-top: 0.5em; display: none;"></p>

        <details style="margin-top: 1em;">
            <summary style="font-size: 0.85em;">Mobile App Setup</summary>
            <div style="font-size: 0.8em; margin-top: 0.5em; padding: 0.5em; background: rgba(100, 200, 150, 0.05); border-radius: 0.3em;">
                <ol style="margin: 0.3em 0 0 1.2em; padding: 0;">
                    <li style="margin: 0.3em 0;">Install the Tesla Sync Health app on your iPhone</li>
                    <li style="margin: 0.3em 0;">Open Settings in the app</li>
                    <li style="margin: 0.3em 0;">Enter your server URL and the API token above</li>
                    <li style="margin: 0.3em 0;">Use "Fetch from Cloud" to get actual battery capacity</li>
                </ol>
            </div>
        </details>
    </article>

    <script>
        // Battery Health Token Management
        async function generateBatteryHealthToken() {
            const status = document.getElementById('battery-health-token-status');
            status.style.display = 'block';
            status.innerHTML = '<span style="color: #fcc419;">Generating token...</span>';

            try {
                const response = await fetch('/api/battery-health/generate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.token) {
                    status.innerHTML = '<span style="color: #51cf66;">‚úì Token generated! Copy it now - it won\'t be shown again in full.</span>';
                    // Reload page to show the new token section
                    setTimeout(() => location.reload(), 1500);
                } else {
                    status.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + (data.error || 'Failed to generate token') + '</span>';
                }
            } catch (error) {
                status.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + error.message + '</span>';
            }
        }

        async function regenerateBatteryHealthToken() {
            if (!confirm('Regenerate API token? The old token will stop working immediately.')) {
                return;
            }
            await generateBatteryHealthToken();
        }

        async function revokeBatteryHealthToken() {
            if (!confirm('Revoke API token? The mobile app will no longer be able to connect.')) {
                return;
            }

            const status = document.getElementById('battery-health-token-status');
            status.style.display = 'block';
            status.innerHTML = '<span style="color: #fcc419;">Revoking token...</span>';

            try {
                const response = await fetch('/api/battery-health/revoke-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    status.innerHTML = '<span style="color: #51cf66;">‚úì Token revoked</span>';
                    setTimeout(() => location.reload(), 1000);
                } else {
                    status.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + (data.error || 'Failed to revoke token') + '</span>';
                }
            } catch (error) {
                status.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + error.message + '</span>';
            }
        }

        async function copyBatteryHealthToken() {
            const status = document.getElementById('battery-health-token-status');
            status.style.display = 'block';
            status.innerHTML = '<span style="color: #fcc419;">Fetching token...</span>';

            try {
                const response = await fetch('/api/battery-health/generate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.token) {
                    // Try clipboard API first, fallback to showing token
                    try {
                        await navigator.clipboard.writeText(data.token);
                        status.innerHTML = '<span style="color: #51cf66;">‚úì Token copied to clipboard!</span>';
                        setTimeout(() => { status.style.display = 'none'; }, 3000);
                    } catch (clipboardError) {
                        // Clipboard API not available (HTTP), show token in copyable field
                        status.innerHTML = `
                            <span style="color: #51cf66;">‚úì Token retrieved! Select and copy:</span><br>
                            <input type="text" value="${data.token}" readonly
                                   style="width: 100%; margin-top: 0.5em; padding: 0.5em; font-family: monospace; font-size: 0.75em;"
                                   onclick="this.select()">
                        `;
                    }
                } else {
                    status.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + (data.error || 'Failed to get token') + '</span>';
                }
            } catch (error) {
                status.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + error.message + '</span>';
            }
        }
    </script>

    <!-- AEMO Spike Testing (separate from main form) - Only for Globird users -->
    {% if current_user.electricity_provider == 'globird' and current_user.aemo_spike_detection_enabled %}
    <article>
        <header><strong>Globird - AEMO Spike Detection Testing</strong></header>
        <p style="font-size: 0.85em;">Test the spike detection system without waiting for a real price spike.</p>

        <form method="POST" action="{{ url_for('main.test_aemo_spike') }}" style="display: inline; margin-right: 0.5em;">
            <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
            <button type="submit" class="outline"
                    onclick="return confirm('This will trigger spike mode using your configured threshold of ${{ current_user.aemo_spike_threshold }}/MWh. Your current tariff will be backed up and a spike tariff will be uploaded to Tesla. Continue?');">
                üö® Simulate Spike
            </button>
        </form>

        {% if current_user.aemo_in_spike_mode %}
        <form method="POST" action="{{ url_for('main.test_aemo_restore') }}" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
            <button type="submit" class="outline"
                    onclick="return confirm('This will exit spike mode and restore your backed-up tariff. Continue?');">
                ‚úì Restore Normal
            </button>
        </form>
        {% endif %}

        <p style="margin: 0.5em 0 0 0; font-size: 0.75em; color: var(--muted-color);">
            Click "Simulate Spike" to test the system. The app will save your current tariff and upload a spike tariff to Tesla.
            {% if current_user.aemo_in_spike_mode %}Click "Restore Normal" to exit spike mode and restore your original tariff.{% endif %}
        </p>
    </article>
    {% endif %}

    <script>
        // Check key status, cloudflared installation, and tunnel status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkKeyStatus();
            checkCloudflaredInstalled();
            checkTunnelStatus();
        });

        // Check if cloudflared CLI is installed
        async function checkCloudflaredInstalled() {
            const statusElements = [
                document.getElementById('cloudflaredStatus'),
                document.getElementById('cloudflaredStatusSetup')
            ];

            try {
                const response = await fetch('{{ url_for("main.check_cloudflared_installed") }}');
                const data = await response.json();

                statusElements.forEach(el => {
                    if (!el) return;
                    if (data.installed) {
                        el.innerHTML = '<span style="color: #51cf66;">‚úì cloudflared ' + data.version + '</span>';
                    } else {
                        el.innerHTML = '<span style="color: #ff6b6b;">‚úó cloudflared not installed</span> - <button onclick="installCloudflared()" style="padding: 0.2em 0.5em; font-size: 0.9em;">Install</button>';
                    }
                });

                // Disable start buttons if cloudflared not installed
                if (!data.installed) {
                    ['startTunnelBtn', 'startTunnelBtnSetup'].forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) {
                            btn.disabled = true;
                            btn.title = 'cloudflared must be installed first';
                        }
                    });
                }
            } catch (error) {
                statusElements.forEach(el => {
                    if (el) el.innerHTML = '<span style="color: #999;">Could not check cloudflared</span>';
                });
            }
        }

        // Install cloudflared automatically
        async function installCloudflared() {
            const statusElements = [
                document.getElementById('cloudflaredStatus'),
                document.getElementById('cloudflaredStatusSetup')
            ];

            statusElements.forEach(el => {
                if (el) el.innerHTML = '<span style="color: #fcc419;">Installing cloudflared...</span>';
            });

            try {
                const response = await fetch('{{ url_for("main.install_cloudflared") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    // Re-check to get version and enable buttons
                    await checkCloudflaredInstalled();
                    await checkTunnelStatus();
                } else {
                    statusElements.forEach(el => {
                        if (el) el.innerHTML = '<span style="color: #ff6b6b;">‚úó Install failed: ' + data.error + '</span>';
                    });
                }
            } catch (error) {
                statusElements.forEach(el => {
                    if (el) el.innerHTML = '<span style="color: #ff6b6b;">‚úó Install failed: ' + error.message + '</span>';
                });
            }
        }

        async function checkTunnelStatus() {
            try {
                const response = await fetch('{{ url_for("main.fleet_api_tunnel_status") }}');
                const data = await response.json();

                // Update connected view elements (if they exist)
                updateTunnelUI('tunnelStatusText', 'tunnelSection', 'tunnelUrlDisplay', 'tunnelUrl',
                              'startTunnelBtn', 'stopTunnelBtn', data);

                // Update setup view elements (if they exist)
                updateTunnelUI('tunnelStatusTextSetup', null, 'tunnelUrlDisplaySetup', 'tunnelUrlSetup',
                              'startTunnelBtnSetup', 'stopTunnelBtnSetup', data);

                // Update the hints in step 2 for setup view
                if (data.active && data.public_url) {
                    const originHint = document.getElementById('allowedOriginHint');
                    const redirectHint = document.getElementById('redirectUriHint');
                    if (originHint) originHint.textContent = data.public_url;
                    if (redirectHint) redirectHint.textContent = data.public_url + '/fleet-api/callback';

                    // Auto-fill the Redirect URI field in the form
                    const redirectUriField = document.getElementById('fleet_api_redirect_uri');
                    if (redirectUriField && (!redirectUriField.value || redirectUriField.value.includes('localhost') || redirectUriField.value.includes('ngrok') || redirectUriField.value.includes('trycloudflare'))) {
                        redirectUriField.value = data.public_url + '/fleet-api/callback';
                    }
                } else {
                    // Reset hints when tunnel is not active
                    const originHint = document.getElementById('allowedOriginHint');
                    const redirectHint = document.getElementById('redirectUriHint');
                    if (originHint) originHint.textContent = '[start tunnel first]';
                    if (redirectHint) redirectHint.textContent = '[start tunnel first]';
                }
            } catch (error) {
                console.error('Failed to check tunnel status:', error);
            }
        }

        function updateTunnelUI(statusTextId, sectionId, urlDisplayId, urlTextId, startBtnId, stopBtnId, data) {
            const statusText = document.getElementById(statusTextId);
            const statusSection = sectionId ? document.getElementById(sectionId) : null;
            const urlDisplay = document.getElementById(urlDisplayId);
            const urlText = document.getElementById(urlTextId);
            const startBtn = document.getElementById(startBtnId);
            const stopBtn = document.getElementById(stopBtnId);

            if (!statusText) return;

            if (data.active && data.public_url) {
                statusText.innerHTML = '<span style="color: #51cf66;">‚úì Active</span>';
                if (statusSection) statusSection.style.background = 'rgba(0, 255, 0, 0.1)';
                if (urlDisplay) urlDisplay.style.display = 'block';
                if (urlText) urlText.textContent = data.public_url;
                if (startBtn) startBtn.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'block';
            } else {
                statusText.innerHTML = '<span style="color: #999;">Not running</span>';
                if (statusSection) statusSection.style.background = 'rgba(100, 150, 255, 0.1)';
                if (urlDisplay) urlDisplay.style.display = 'none';
                if (startBtn) startBtn.style.display = 'block';
                if (stopBtn) stopBtn.style.display = 'none';
            }
        }

        async function startTunnel() {
            // Get buttons from both views
            const btn = document.getElementById('startTunnelBtn') || document.getElementById('startTunnelBtnSetup');
            const status = document.getElementById('tunnelActionStatus') || document.getElementById('tunnelActionStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Starting...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Starting Cloudflare tunnel... (may take 10-20 seconds)';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_start_tunnel") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    status.style.color = '#51cf66';
                    status.textContent = '‚úì Tunnel started! Update Tesla Developer Portal with the URL shown above.';
                    checkTunnelStatus();
                } else {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó ' + data.error;
                    btn.disabled = false;
                    btn.textContent = 'Start Tunnel';
                }
            } catch (error) {
                status.style.color = '#ff6b6b';
                status.textContent = '‚úó Request failed: ' + error.message;
                btn.disabled = false;
                btn.textContent = 'Start Tunnel';
            }
        }

        async function stopTunnel() {
            // Get buttons from both views
            const btn = document.getElementById('stopTunnelBtn') || document.getElementById('stopTunnelBtnSetup');
            const status = document.getElementById('tunnelActionStatus') || document.getElementById('tunnelActionStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Stopping...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Stopping tunnel...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_stop_tunnel") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    if (status) {
                        status.style.color = '#51cf66';
                        status.textContent = '‚úì Tunnel stopped';
                    }
                    checkTunnelStatus();
                    // Reset hints
                    const originHint = document.getElementById('allowedOriginHint');
                    const redirectHint = document.getElementById('redirectUriHint');
                    if (originHint) originHint.textContent = '[start tunnel first]';
                    if (redirectHint) redirectHint.textContent = '[start tunnel first]';
                } else {
                    if (status) {
                        status.style.color = '#ff6b6b';
                        status.textContent = '‚úó ' + data.error;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Stop Tunnel';
                    }
                }
            } catch (error) {
                if (status) {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó Request failed: ' + error.message;
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Stop Tunnel';
                }
            }
        }

        // Named tunnel functions
        async function saveTunnelConfig() {
            const statusEl = document.getElementById('namedTunnelStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #fcc419;">Saving...</span>';

            try {
                const response = await fetch('{{ url_for("main.save_tunnel_config") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tunnel_token: document.getElementById('tunnelToken').value,
                        tunnel_domain: document.getElementById('tunnelDomain').value,
                        tunnel_enabled: document.getElementById('tunnelAutoStart').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #51cf66;">‚úì Configuration saved!</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + data.error + '</span>';
                }
            } catch (error) {
                statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó Request failed: ' + error.message + '</span>';
            }
        }

        async function saveTunnelConfigSetup() {
            const statusEl = document.getElementById('namedTunnelStatusSetup');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #fcc419;">Saving...</span>';

            try {
                const response = await fetch('{{ url_for("main.save_tunnel_config") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tunnel_token: document.getElementById('tunnelTokenSetup').value,
                        tunnel_domain: document.getElementById('tunnelDomainSetup').value,
                        tunnel_enabled: document.getElementById('tunnelAutoStartSetup').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #51cf66;">‚úì Saved!</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + data.error + '</span>';
                }
            } catch (error) {
                statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + error.message + '</span>';
            }
        }

        async function startNamedTunnel() {
            const statusEl = document.getElementById('namedTunnelStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #fcc419;">Starting named tunnel...</span>';

            try {
                const response = await fetch('{{ url_for("main.fleet_api_start_named_tunnel") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #51cf66;">‚úì Connected to ' + data.domain + '</span>';
                    checkTunnelStatus();
                } else {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó Error: ' + data.error + '</span>';
                }
            } catch (error) {
                statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó Request failed: ' + error.message + '</span>';
            }
        }

        async function startNamedTunnelSetup() {
            const statusEl = document.getElementById('namedTunnelStatusSetup');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: #fcc419;">Starting...</span>';

            try {
                const response = await fetch('{{ url_for("main.fleet_api_start_named_tunnel") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                if (data.success) {
                    statusEl.innerHTML = '<span style="color: #51cf66;">‚úì ' + data.domain + '</span>';
                    checkTunnelStatus();
                    // Update hints with the named tunnel URL
                    const originHint = document.getElementById('allowedOriginHint');
                    const redirectHint = document.getElementById('redirectUriHint');
                    if (originHint) originHint.textContent = data.public_url;
                    if (redirectHint) redirectHint.textContent = data.public_url + '/fleet-api/callback';
                } else {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + data.error + '</span>';
                }
            } catch (error) {
                statusEl.innerHTML = '<span style="color: #ff6b6b;">‚úó ' + error.message + '</span>';
            }
        }

        // Energy site selection functions
        async function loadEnergySites() {
            const container = document.getElementById('site-selector-container');
            const select = document.getElementById('energy-site-select');
            const status = document.getElementById('site-save-status');

            try {
                select.innerHTML = '<option value="">Loading...</option>';
                container.style.display = 'block';

                const response = await fetch('/api/tesla/energy-sites');
                const data = await response.json();

                if (data.error && !data.sites.length) {
                    select.innerHTML = '<option value="">Tesla not connected</option>';
                    return;
                }

                if (data.sites.length === 0) {
                    select.innerHTML = '<option value="">No energy sites found</option>';
                    return;
                }

                select.innerHTML = '';
                data.sites.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site.id;
                    option.textContent = `${site.name} (${site.id})`;
                    if (site.selected) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                if (data.sites.length > 1) {
                    status.textContent = `Found ${data.sites.length} energy sites`;
                    status.style.display = 'block';
                    status.style.color = '#888';
                }

            } catch (error) {
                console.error('Error loading energy sites:', error);
                select.innerHTML = '<option value="">Error loading sites</option>';
            }
        }

        async function saveSelectedSite() {
            const select = document.getElementById('energy-site-select');
            const status = document.getElementById('site-save-status');
            const siteId = select.value;

            if (!siteId) {
                status.textContent = 'Please select a site';
                status.style.display = 'block';
                status.style.color = 'orange';
                return;
            }

            try {
                status.textContent = 'Saving...';
                status.style.display = 'block';
                status.style.color = '#888';

                const response = await fetch('/api/tesla/select-site', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ site_id: siteId })
                });

                const data = await response.json();

                if (data.success) {
                    status.textContent = '‚úì Site saved successfully';
                    status.style.color = '#51cf66';

                    // Update the status display
                    const statusDiv = document.getElementById('energy-site-status');
                    statusDiv.style.background = 'rgba(0, 255, 0, 0.1)';
                    statusDiv.innerHTML = `
                        <p style="margin: 0; color: #51cf66; font-size: 0.9em;">‚úÖ <strong>Selected</strong></p>
                        <p style="margin: 0.3em 0 0 0; font-size: 0.85em;">
                            Site ID: <code id="current-site-id">${siteId}</code>
                        </p>
                    `;
                } else {
                    status.textContent = '‚úó ' + (data.error || 'Failed to save');
                    status.style.color = 'red';
                }
            } catch (error) {
                console.error('Error saving site:', error);
                status.textContent = '‚úó Error saving site';
                status.style.color = 'red';
            }
        }

        async function checkKeyStatus() {
            try {
                const response = await fetch('{{ url_for("main.fleet_api_key_status") }}');
                const data = await response.json();

                // Update connected view
                updateKeyStatusUI('keyStatusText', 'keyStatusSection', 'generateKeysBtn', data);
                // Update setup view
                updateKeyStatusUI('keyStatusTextSetup', 'keyStatusSectionSetup', 'generateKeysBtnSetup', data);
            } catch (error) {
                console.error('Failed to check key status:', error);
            }
        }

        function updateKeyStatusUI(statusTextId, statusSectionId, generateBtnId, data) {
            const statusText = document.getElementById(statusTextId);
            const statusSection = document.getElementById(statusSectionId);
            const generateBtn = document.getElementById(generateBtnId);

            if (!statusText) return; // Element doesn't exist on this page

            if (data.keys_exist) {
                statusText.innerHTML = '<span style="color: #51cf66;">‚úì Keys configured</span>';
                if (statusSection) statusSection.style.background = 'rgba(0, 255, 0, 0.1)';
                if (generateBtn) generateBtn.textContent = 'Regenerate Domain Keys';
            } else {
                statusText.innerHTML = '<span style="color: #ff6b6b;">‚úó Keys not found</span>';
                if (statusSection) statusSection.style.background = 'rgba(255, 100, 100, 0.1)';
            }
        }

        async function generateKeys() {
            // Get buttons from both views
            const btn = document.getElementById('generateKeysBtn') || document.getElementById('generateKeysBtnSetup');
            const status = document.getElementById('generateKeysStatus') || document.getElementById('generateKeysStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Generating...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Creating EC key pair...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_generate_keys") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (status) {
                        status.style.color = '#51cf66';
                        if (data.keys_replaced) {
                            status.textContent = '‚úì Keys regenerated successfully';
                        } else {
                            status.textContent = '‚úì Keys generated successfully';
                        }
                    }
                    if (btn) {
                        btn.textContent = 'Regenerate Domain Keys';
                        btn.disabled = false;
                    }
                    // Update the key status display
                    checkKeyStatus();
                } else {
                    if (status) {
                        status.style.color = '#ff6b6b';
                        status.textContent = '‚úó ' + data.error;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Generate Domain Keys';
                    }
                }
            } catch (error) {
                if (status) {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó Request failed: ' + error.message;
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Generate Domain Keys';
                }
            }
        }

        async function deleteKeys() {
            if (!confirm('Delete domain keys? You will need to regenerate and re-register with Tesla.')) {
                return;
            }

            const btn = document.getElementById('deleteKeysBtn');
            const status = document.getElementById('generateKeysStatus');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Deleting...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Deleting keys...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_delete_keys") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    if (status) {
                        status.style.color = '#51cf66';
                        status.textContent = '‚úì ' + data.message;
                    }
                    // Update the key status display
                    checkKeyStatus();
                } else {
                    if (status) {
                        status.style.color = '#ff6b6b';
                        status.textContent = '‚úó ' + (data.error || 'Failed to delete keys');
                    }
                }
            } catch (error) {
                if (status) {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó Error: ' + error.message;
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Delete Keys';
                }
            }
        }

        async function registerDomain() {
            // Get buttons from both views
            const btn = document.getElementById('registerDomainBtn') || document.getElementById('registerDomainBtnSetup');
            const status = document.getElementById('registerDomainStatus') || document.getElementById('registerDomainStatusSetup');

            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Registering...';
            }
            if (status) {
                status.style.display = 'block';
                status.textContent = 'Contacting Tesla...';
                status.style.color = '#666';
            }

            try {
                const response = await fetch('{{ url_for("main.fleet_api_register_partner") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    if (status) {
                        status.style.color = '#51cf66';
                        if (data.already_registered) {
                            status.textContent = '‚úì ' + data.message;
                        } else {
                            status.textContent = '‚úì ' + data.message + ' - API should now work!';
                        }
                    }
                    if (btn) btn.textContent = 'Domain Registered ‚úì';
                } else {
                    if (status) {
                        status.style.color = '#ff6b6b';
                        status.textContent = '‚úó ' + data.error;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Register Domain with Tesla';
                    }
                }
            } catch (error) {
                if (status) {
                    status.style.color = '#ff6b6b';
                    status.textContent = '‚úó Request failed: ' + error.message;
                }
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Register Domain with Tesla';
                }
            }
        }

        function toggleGlobirdAemoFields(enabled) {
            const fields = document.getElementById('globird-aemo-fields');
            if (fields) {
                fields.style.display = enabled ? 'block' : 'none';
            }
        }

        // Toggle provider-specific settings based on electricity provider selection
        function toggleProviderSettings() {
            const provider = document.getElementById('electricity_provider').value;
            const amberSettings = document.getElementById('amberSettings');
            const flowPowerSettings = document.getElementById('flowPowerSettings');
            const globirdSettings = document.getElementById('globirdSettings');

            // Hide all provider-specific settings first
            if (amberSettings) amberSettings.style.display = 'none';
            if (flowPowerSettings) flowPowerSettings.style.display = 'none';
            if (globirdSettings) globirdSettings.style.display = 'none';

            // Show the selected provider's settings
            if (provider === 'flow_power') {
                if (flowPowerSettings) flowPowerSettings.style.display = 'block';
            } else if (provider === 'globird') {
                if (globirdSettings) globirdSettings.style.display = 'block';
            } else {
                // Default to Amber
                if (amberSettings) amberSettings.style.display = 'block';
            }
        }

        // Toggle Amber token field in Flow Power settings based on price source
        function toggleFlowPowerAmberToken() {
            const priceSource = document.getElementById('flow_power_price_source').value;
            const amberTokenDiv = document.getElementById('flowPowerAmberToken');
            const networkTariffDiv = document.getElementById('networkTariffConfig');
            const peaSettingsDiv = document.getElementById('peaSettings');

            if (amberTokenDiv) {
                amberTokenDiv.style.display = (priceSource === 'aemo') ? 'none' : 'block';
            }
            // Show network tariff config only when using AEMO (for non-PEA fallback)
            if (networkTariffDiv) {
                networkTariffDiv.style.display = (priceSource === 'aemo') ? 'block' : 'none';
            }
            // PEA settings always shown for Flow Power (works with both AEMO and Amber)
            if (peaSettingsDiv) {
                peaSettingsDiv.style.display = 'block';
            }
        }

        // Toggle PEA settings detail visibility
        function togglePeaSettings() {
            const peaEnabled = document.getElementById('pea_enabled').checked;
            const peaDetail = document.getElementById('peaSettingsDetail');
            const peaDisabledNote = document.getElementById('peaDisabledNote');

            if (peaDetail) {
                peaDetail.style.display = peaEnabled ? 'block' : 'none';
            }
            if (peaDisabledNote) {
                peaDisabledNote.style.display = peaEnabled ? 'none' : 'block';
            }
        }

        // Toggle manual rates section visibility
        function toggleManualRates() {
            const useManual = document.getElementById('network_use_manual_rates').checked;
            const manualSection = document.getElementById('manualRatesSection');
            if (manualSection) {
                manualSection.style.display = useManual ? 'block' : 'none';
            }
        }

        // Network tariffs per distributor (from aemo_to_tariff library)
        const NETWORK_TARIFFS = {
            "energex": {
                "6900": "Residential Time of Use",
                "8400": "Residential Flat",
                "3700": "Residential Demand",
                "3900": "Residential Transitional Demand",
                "6800": "Small Business ToU",
                "8500": "Small Business Flat",
                "3600": "Small Business Demand",
                "3800": "Small Business Transitional Demand",
                "6000": "Small Business Wide IFT",
                "8800": "Small 8800 TOU",
                "8900": "Small 8900 TOU",
                "6600": "Large Residential Energy",
                "6700": "Large Business Energy",
                "7200": "LV Demand Time-of-Use",
                "8100": "Demand Large",
                "8300": "SAC Demand Small",
                "94300": "Large TOU Energy"
            },
            "ergon": {
                "6900": "Residential Time of Use",
                "ERTOUET1": "Residential Battery ToU",
                "WRTOUET1": "Residential Wide ToU",
                "MRTOUET4": "Residential Multi ToU"
            },
            "ausgrid": {
                "EA025": "Residential ToU",
                "EA010": "Residential Flat",
                "EA111": "Residential Demand (Intro)",
                "EA116": "Residential Demand",
                "EA225": "Small Business ToU",
                "EA305": "Small Business LV"
            },
            "endeavour": {
                "N71": "Residential Seasonal TOU",
                "N70": "Residential Flat",
                "N90": "General Supply Block",
                "N91": "GS Seasonal TOU",
                "N19": "LV Seasonal STOU Demand",
                "N95": "Storage"
            },
            "essential": {
                "BLNT3AU": "Residential TOU (Basic)",
                "BLNT3AL": "Residential TOU (Interval)",
                "BLNN2AU": "Residential Anytime",
                "BLNRSS2": "Residential Sun Soaker",
                "BLND1AR": "Residential Demand",
                "BLNT2AU": "Small Business TOU (Basic)",
                "BLNT2AL": "Small Business TOU (Interval)",
                "BLNN1AU": "Small Business Anytime",
                "BLNBSS1": "Small Business Sun Soaker",
                "BLND1AB": "Small Business Demand",
                "BLNC1AU": "Controlled Load 1",
                "BLNC2AU": "Controlled Load 2",
                "BLNT1AO": "Small Business TOU (100-160 MWh)"
            },
            "sapower": {
                "RTOU": "Residential Time of Use",
                "RSR": "Residential Single Rate",
                "RTOUNE": "Residential TOU (New)",
                "RPRO": "Residential Prosumer",
                "RELE": "Residential Electrify",
                "RESELE": "Residential Electrify (Alt)",
                "RELE2W": "Residential Electrify 2W",
                "SBTOU": "Small Business Time of Use",
                "SBTOUNE": "Small Business TOU (New)",
                "SBELE": "Small Business Electrify",
                "B2R": "Business Two Rate"
            },
            "powercor": {
                "PRTOU": "Residential TOU",
                "D1": "Residential Single Rate",
                "NDMO21": "NDMO21 TOU",
                "NDTOU": "NDTOU TOU",
                "PRDS": "Residential Daytime Saver"
            },
            "citipower": {
                "VICR_TOU": "Residential Time of Use",
                "VICR_SINGLE": "Residential Single Rate",
                "VICR_DEMAND": "Residential Demand",
                "VICS_TOU": "Small Business Time of Use",
                "VICS_SINGLE": "Small Business Single Rate",
                "VICS_DEMAND": "Small Business Demand"
            },
            "ausnet": {
                "NAST11S": "Small Business Time of Use"
            },
            "jemena": {
                "PRTOU": "Residential TOU",
                "D1": "Residential Single Rate"
            },
            "united": {
                "VICR_TOU": "Residential Time of Use",
                "VICR_SINGLE": "Residential Single Rate",
                "VICR_DEMAND": "Residential Demand",
                "VICS_TOU": "Small Business Time of Use",
                "VICS_SINGLE": "Small Business Single Rate",
                "VICS_DEMAND": "Small Business Demand"
            },
            "tasnetworks": {
                "TAS93": "Residential TOU Consumption",
                "TAS87": "Residential TOU Demand",
                "TAS97": "Residential TOU CER",
                "TAS94": "Small Business TOU Consumption",
                "TAS88": "Small Business TOU Demand"
            },
            "evoenergy": {
                "017": "Residential TOU Network",
                "018": "Residential TOU Network XMC",
                "015": "Residential TOU (Closed)",
                "016": "Residential TOU XMC (Closed)",
                "026": "Residential Demand",
                "090": "Component Charge"
            }
        };

        // Update tariff code dropdown based on selected distributor
        function updateTariffCodes() {
            const distributor = document.getElementById('network_distributor').value;
            const tariffSelect = document.getElementById('network_tariff_code');
            const currentValue = '{{ current_user.network_tariff_code or "6900" }}';

            if (!tariffSelect) return;

            // Clear existing options
            tariffSelect.innerHTML = '';

            // Get tariffs for selected distributor
            const tariffs = NETWORK_TARIFFS[distributor] || {};

            // Add options
            for (const [code, name] of Object.entries(tariffs)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${name}`;
                if (code === currentValue) {
                    option.selected = true;
                }
                tariffSelect.appendChild(option);
            }
        }

        // Initialize tariff dropdown on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateTariffCodes();
        });

        // Toggle between flat rate and TOU network tariff configuration
        function toggleNetworkTariffType() {
            const tariffType = document.getElementById('network_tariff_type').value;
            const flatConfig = document.getElementById('networkFlatRateConfig');
            const touConfig = document.getElementById('networkTOUConfig');

            if (flatConfig) {
                flatConfig.style.display = (tariffType === 'flat') ? 'block' : 'none';
            }
            if (touConfig) {
                touConfig.style.display = (tariffType === 'tou') ? 'block' : 'none';
            }
        }

        // Toggle Tesla provider settings based on API provider selection
        function toggleTeslaProviderSettings() {
            const provider = document.getElementById('tesla_api_provider').value;
            const teslemetrySettings = document.getElementById('teslemetrySettings');
            const fleetApiSettings = document.getElementById('fleetApiSettings');

            if (provider === 'fleet_api') {
                if (teslemetrySettings) teslemetrySettings.style.display = 'none';
                if (fleetApiSettings) fleetApiSettings.style.display = 'block';
            } else {
                // Default to Teslemetry
                if (teslemetrySettings) teslemetrySettings.style.display = 'block';
                if (fleetApiSettings) fleetApiSettings.style.display = 'none';
            }
        }

        function toggleVisibility(fieldId, button) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';  // Eye with slash (hidden)
                button.style.opacity = '1';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';  // Eye (visible)
                button.style.opacity = '0.6';
            }
        }

        // Initialize all secure fields as password type on page load
        document.addEventListener('DOMContentLoaded', function() {
            const secureFields = document.querySelectorAll('.secure-field');
            secureFields.forEach(field => {
                field.type = 'password';
            });
        });
    </script>
{% endblock settings_content %}
