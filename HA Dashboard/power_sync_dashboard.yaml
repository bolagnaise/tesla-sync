title: PowerSync
views:
  - title: Energy Dashboard
    path: energy
    icon: mdi:lightning-bolt
    cards:
      # Compact Gauges
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.current_import_price
            name: Import
            unit: $/kWh
            min: 0
            max: 0.60
            needle: true
            severity:
              green: 0
              yellow: 0.25
              red: 0.40
            card_mod:
              style: |
                ha-card {
                  height: 140px;
                }
          - type: gauge
            entity: sensor.current_export_price
            name: Export Earnings
            unit: $/kWh
            min: -0.10
            max: 0.30
            needle: true
            severity:
              red: -0.10
              yellow: 0
              green: 0.05
            card_mod:
              style: |
                ha-card {
                  height: 140px;
                }
          - type: gauge
            entity: sensor.battery_level
            name: Battery
            unit: '%'
            min: 0
            max: 100
            needle: true
            severity:
              red: 0
              yellow: 30
              green: 60
            card_mod:
              style: |
                ha-card {
                  height: 140px;
                }
      # Battery Control Buttons
      # SETUP REQUIRED:
      # 1. Create input_select helpers via Settings > Devices > Helpers > Dropdown:
      #    - Name: Force Charge Duration | Entity ID: input_select.force_charge_duration | Options: 15, 30, 45, 60, 90, 120
      #    - Name: Force Discharge Duration | Entity ID: input_select.force_discharge_duration | Options: 15, 30, 45, 60, 90, 120
      # 2. Create scripts in configuration.yaml or via Settings > Automations & Scenes > Scripts:
      #    script:
      #      power_sync_force_charge:
      #        alias: "PowerSync Force Charge"
      #        sequence:
      #          - service: power_sync.force_charge
      #            data:
      #              duration: "{{ states('input_select.force_charge_duration') | int }}"
      #      power_sync_force_discharge:
      #        alias: "PowerSync Force Discharge"
      #        sequence:
      #          - service: power_sync.force_discharge
      #            data:
      #              duration: "{{ states('input_select.force_discharge_duration') | int }}"
      - type: custom:mushroom-chips-card
        alignment: center
        chips:
          # Force Charge Duration Selector
          - type: template
            icon: mdi:timer-outline
            icon_color: blue
            content: "{{ states('input_select.force_charge_duration') }} min"
            tap_action:
              action: more-info
              entity: input_select.force_charge_duration
          # Force Charge Button
          - type: template
            icon: mdi:battery-charging
            icon_color: blue
            content: Force Charge
            tap_action:
              action: call-service
              service: script.power_sync_force_charge
              confirmation:
                text: "Force charge for {{ states('input_select.force_charge_duration') }} minutes?"
          # Force Discharge Duration Selector
          - type: template
            icon: mdi:timer-outline
            icon_color: orange
            content: "{{ states('input_select.force_discharge_duration') }} min"
            tap_action:
              action: more-info
              entity: input_select.force_discharge_duration
          # Force Discharge Button
          - type: template
            icon: mdi:battery-arrow-down
            icon_color: orange
            content: Force Discharge
            tap_action:
              action: call-service
              service: script.power_sync_force_discharge
              confirmation:
                text: "Force discharge for {{ states('input_select.force_discharge_duration') }} minutes?"
          # Restore Normal
          - type: template
            icon: mdi:battery-sync
            icon_color: green
            content: Restore Normal
            tap_action:
              action: call-service
              service: power_sync.restore_normal
              confirmation:
                text: Restore normal battery operation?
      - type: custom:power-flow-card-plus
        entities:
          battery:
            entity: sensor.battery_power
            state_of_charge: sensor.battery_level
            name: Battery
            color_icon: true
            display_state: two_way
          grid:
            entity: sensor.grid_power
            name: Grid
            color_icon: true
            display_state: two_way
          solar:
            entity: sensor.solar_power
            name: Solar
            color_icon: true
            display_state: one_way
          home:
            entity: sensor.home_load
            name: Home
            color_icon: true
        watt_threshold: 0
        kw_decimals: 2
        min_flow_rate: 0.75
        max_flow_rate: 6
        display_zero_lines: false
        clickable_entities: true
        use_new_flow_rate_model: true
      - type: custom:apexcharts-card
        header:
          show: true
          title: Electricity Prices - 24 Hours
          show_states: false
        graph_span: 24h
        span:
          start: day
        yaxis:
          - id: price
            min: 0
            apex_config:
              tickAmount: 5
              labels:
                formatter: |
                  EVAL:function(val) {
                    return (val * 100).toFixed(0) + '¢';
                  }
        series:
          - entity: sensor.current_import_price
            name: Import
            type: line
            color: '#FF9800'
            yaxis_id: price
            stroke_width: 2
            group_by:
              func: avg
              duration: 5min
          - entity: sensor.current_export_price
            name: Export Earnings
            type: line
            color: '#4CAF50'
            yaxis_id: price
            stroke_width: 2
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 200
          stroke:
            curve: smooth
          legend:
            show: true
            position: bottom
          tooltip:
            x:
              format: HH:mm
      - type: custom:apexcharts-card
        header:
          show: true
          title: TOU Schedule Sent to Tesla
          show_states: false
        graph_span: 24h
        span:
          start: day
        yaxis:
          - id: price
            min: 0
            apex_config:
              tickAmount: 5
              labels:
                formatter: |
                  EVAL:function(val) {
                    return (val * 100).toFixed(0) + '¢';
                  }
        series:
          - entity: sensor.tariff_schedule
            name: Buy Price
            type: line
            color: '#FF9800'
            yaxis_id: price
            stroke_width: 2
            curve: stepline
            extend_to: end
            data_generator: >
              const schedule = entity.attributes.schedule || [];

              const now = new Date();

              const today = new Date(now.getFullYear(), now.getMonth(),
              now.getDate());

              const data = schedule.map((entry) => {
                const [hours, mins] = entry.time.split(':').map(Number);
                const timestamp = new Date(today.getTime() + hours * 3600000 + mins * 60000);
                return [timestamp.getTime(), entry.buy];
              });

              if (data.length > 0) {
                const endOfDay = new Date(today.getTime() + 24 * 3600000 - 1);
                data.push([endOfDay.getTime(), data[data.length - 1][1]]);
              }

              return data;
          - entity: sensor.tariff_schedule
            name: Sell Price
            type: line
            color: '#4CAF50'
            yaxis_id: price
            stroke_width: 2
            curve: stepline
            extend_to: end
            data_generator: >
              const schedule = entity.attributes.schedule || [];

              const now = new Date();

              const today = new Date(now.getFullYear(), now.getMonth(),
              now.getDate());

              const data = schedule.map((entry) => {
                const [hours, mins] = entry.time.split(':').map(Number);
                const timestamp = new Date(today.getTime() + hours * 3600000 + mins * 60000);
                return [timestamp.getTime(), entry.sell];
              });

              if (data.length > 0) {
                const endOfDay = new Date(today.getTime() + 24 * 3600000 - 1);
                data.push([endOfDay.getTime(), data[data.length - 1][1]]);
              }

              return data;
        apex_config:
          chart:
            height: 200
          stroke:
            curve: stepline
          legend:
            show: true
            position: bottom
          tooltip:
            x:
              format: HH:mm
      # Solar Curtailment Status Cards - Side by Side
      - type: horizontal-stack
        cards:
          # DC Solar Curtailment (Tesla Powerwall)
          - type: custom:mushroom-template-card
            entity: sensor.solar_curtailment
            primary: DC Solar (Tesla)
            secondary: >-
              {% set state = states('sensor.solar_curtailment') %}
              {% if state == 'Active' %}
              CURTAILED - Export blocked
              {% else %}
              Normal - Export allowed
              {% endif %}
            icon: >-
              {% set state = states('sensor.solar_curtailment') %}
              {% if state == 'Active' %}
              mdi:solar-power-variant-outline
              {% else %}
              mdi:solar-power-variant
              {% endif %}
            icon_color: >-
              {% set state = states('sensor.solar_curtailment') %}
              {% if state == 'Active' %}
              red
              {% else %}
              green
              {% endif %}
            badge_icon: >-
              {% set state = states('sensor.solar_curtailment') %}
              {% if state == 'Active' %}
              mdi:close-circle
              {% endif %}
            badge_color: red
            tap_action:
              action: more-info
            card_mod:
              style: |
                ha-card {
                  {% set state = states('sensor.solar_curtailment') %}
                  {% if state == 'Active' %}
                  background: linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(244, 67, 54, 0.05) 100%);
                  {% else %}
                  background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.05) 100%);
                  {% endif %}
                }
          # AC-Coupled Inverter Status
          - type: custom:mushroom-template-card
            entity: sensor.inverter_status
            primary: AC Inverter
            secondary: >-
              {% set state = states('sensor.inverter_status') %}
              {% set power = state_attr('sensor.inverter_status', 'power_limit_percent') %}
              {% set brand = state_attr('sensor.inverter_status', 'brand') %}
              {% if state == 'unavailable' or state == 'unknown' %}
              Not configured
              {% elif state == 'Curtailed' %}
              CURTAILED{% if power %} - {{ power }}%{% endif %}
              {% elif state == 'Offline' %}
              Offline - Cannot reach
              {% else %}
              {{ brand | title if brand else 'Normal' }}{% if power %} - {{ power }}%{% endif %}
              {% endif %}
            icon: mdi:solar-panel
            icon_color: >-
              {% set state = states('sensor.inverter_status') %}
              {% if state == 'Curtailed' %}
              red
              {% elif state == 'Offline' %}
              orange
              {% elif state == 'unavailable' or state == 'unknown' %}
              disabled
              {% else %}
              green
              {% endif %}
            badge_icon: >-
              {% set state = states('sensor.inverter_status') %}
              {% if state == 'Curtailed' %}
              mdi:close-circle
              {% elif state == 'Offline' %}
              mdi:alert-circle
              {% endif %}
            badge_color: >-
              {% set state = states('sensor.inverter_status') %}
              {% if state == 'Curtailed' %}
              red
              {% elif state == 'Offline' %}
              orange
              {% endif %}
            tap_action:
              action: more-info
            card_mod:
              style: |
                ha-card {
                  {% set state = states('sensor.inverter_status') %}
                  {% if state == 'Curtailed' %}
                  background: linear-gradient(135deg, rgba(244, 67, 54, 0.15) 0%, rgba(244, 67, 54, 0.05) 100%);
                  {% elif state == 'Offline' %}
                  background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(255, 152, 0, 0.05) 100%);
                  {% elif state == 'unavailable' or state == 'unknown' %}
                  background: linear-gradient(135deg, rgba(158, 158, 158, 0.1) 0%, rgba(158, 158, 158, 0.05) 100%);
                  {% else %}
                  background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.05) 100%);
                  {% endif %}
                }
      # Battery Health Gauges
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.battery_health
            name: Overall
            unit: '%'
            min: 0
            max: 115
            needle: true
            severity:
              green: 95
              yellow: 85
              red: 0
          - type: gauge
            entity: sensor.battery_health
            attribute: battery_1_health_percent
            name: Battery 1
            unit: '%'
            min: 0
            max: 115
            needle: true
            severity:
              green: 95
              yellow: 85
              red: 0
          - type: gauge
            entity: sensor.battery_health
            attribute: battery_2_health_percent
            name: Battery 2
            unit: '%'
            min: 0
            max: 115
            needle: true
            severity:
              green: 95
              yellow: 85
              red: 0
          - type: gauge
            entity: sensor.battery_health
            attribute: battery_3_health_percent
            name: Battery 3
            unit: '%'
            min: 0
            max: 115
            needle: true
            severity:
              green: 95
              yellow: 85
              red: 0
      # Battery Capacity Details
      - type: markdown
        content: |
          {% set original = state_attr('sensor.battery_health', 'original_capacity_kwh') %}
          {% set current = state_attr('sensor.battery_health', 'current_capacity_kwh') %}
          {% set scan = state_attr('sensor.battery_health', 'last_scan') %}
          {%- if states('sensor.battery_health') not in ['unavailable', 'unknown'] %}
          **Capacity:** {{ current }} / {{ original }} kWh | **Last scan:** {{ scan[:10] if scan else 'N/A' }}
          {%- else %}
          Scan from the PowerSync Mobile app while connected to Powerwall WiFi.
          {%- endif %}
      - type: custom:apexcharts-card
        header:
          show: true
          title: Solar
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.solar_power
            name: Solar
            type: area
            color: '#FFD700'
            stroke_width: 2
            extend_to: end
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
          yaxis:
            min: 0
      - type: custom:apexcharts-card
        header:
          show: true
          title: Battery
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.battery_power
            name: Battery
            type: area
            color: '#2196F3'
            stroke_width: 2
            extend_to: end
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
      - type: custom:apexcharts-card
        header:
          show: true
          title: Grid
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.grid_power
            name: Grid
            type: area
            color: '#F44336'
            stroke_width: 2
            extend_to: end
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
      - type: custom:apexcharts-card
        header:
          show: true
          title: Home
          show_states: true
        graph_span: 24h
        span:
          start: day
        series:
          - entity: sensor.home_load
            name: Home
            type: area
            color: '#9C27B0'
            stroke_width: 2
            extend_to: end
            group_by:
              func: avg
              duration: 5min
        apex_config:
          chart:
            height: 150
          yaxis:
            min: 0
